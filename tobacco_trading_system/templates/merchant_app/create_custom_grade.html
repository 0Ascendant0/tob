{% extends 'base.html' %}
{% load static %}

{% block title %}Create Custom Grade - Merchant Dashboard{% endblock %}

{% block extra_css %}
<style>
    .component-row {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #f8f9fa;
        transition: all 0.3s ease;
        position: relative;
    }
    .component-row.valid {
        border-color: #28a745;
        background: #d4edda;
    }
    .component-row.invalid {
        border-color: #dc3545;
        background: #f8d7da;
    }
    .grade-preview {
        border: 2px solid var(--merchant-secondary, #007bff);
        border-radius: 12px;
        padding: 1.5rem;
        background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        position: sticky;
        top: 2rem;
        max-height: calc(100vh - 4rem);
        overflow-y: auto;
    }
    .percentage-meter {
        height: 30px;
        background: #e9ecef;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
        margin: 1rem 0;
    }
    .percentage-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--merchant-secondary, #007bff), var(--merchant-accent, #0056b3));
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        min-width: 30px;
    }
    .remove-component {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        cursor: pointer;
        z-index: 10;
    }
    .remove-component:hover {
        background: #c82333;
    }
    .component-bar {
        height: 20px;
        border-radius: 10px;
        margin: 0.5rem 0;
        position: relative;
        overflow: hidden;
        background: #e9ecef;
    }
    .component-fill {
        height: 100%;
        transition: width 0.3s ease;
        background: linear-gradient(90deg, #007bff, #0056b3);
    }
    .custom-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    .card-header-custom {
        background: linear-gradient(135deg, var(--merchant-primary, #007bff), var(--merchant-secondary, #0056b3));
        color: white;
        padding: 1rem 1.5rem;
        font-weight: 600;
    }
    .alert-info-custom {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border: none;
        border-left: 4px solid #2196f3;
        border-radius: 8px;
        color: #1565c0;
    }
    .alert-warning-custom {
        background: linear-gradient(135deg, #fff3e0, #ffcc02);
        border: none;
        border-left: 4px solid #ff9800;
        border-radius: 8px;
        color: #f57f17;
    }
    .btn-primary-custom {
        background: linear-gradient(135deg, var(--merchant-primary, #007bff), var(--merchant-secondary, #0056b3));
        border: none;
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    .btn-primary-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        color: white;
    }
    .grade-demand-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
    }
    .demand-high { background: #d4edda; color: #155724; }
    .demand-medium { background: #fff3cd; color: #856404; }
    .demand-low { background: #f8d7da; color: #721c24; }
    
    @media (max-width: 768px) {
        .grade-preview {
            position: static;
            margin-top: 2rem;
        }
        .component-row {
            padding: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'merchant_dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'merchant_custom_grades' %}">Custom Grades</a></li>
                    <li class="breadcrumb-item active">Create New Grade</li>
                </ol>
            </nav>
            <h1 class="h3 mb-0">Create Custom Grade</h1>
            <p class="text-muted">Design a custom tobacco grade by blending different TIMB base grades</p>
        </div>
    </div>

    <form id="customGradeForm" class="row">
        {% csrf_token %}
        <div class="col-lg-8">
            <!-- Basic Information -->
            <div class="custom-card mb-4">
                <div class="card-header-custom">
                    <h5 class="mb-0">Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Custom Grade Name *</label>
                            <input type="text" class="form-control" name="custom_grade_name" required 
                                   placeholder="e.g., Premium Blend A1" onchange="updatePreview()">
                            <div class="form-text">Choose a descriptive name for your custom blend</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Target Price ($/kg) *</label>
                            <input type="number" class="form-control" name="target_price" step="0.01" min="0" required
                                   placeholder="5.50" onchange="updatePreview()">
                            <div class="form-text">Expected selling price per kilogram</div>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="3" onchange="updatePreview()"
                                      placeholder="Describe the characteristics and intended use of this custom grade..."></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Minimum Order Quantity (kg)</label>
                            <input type="number" class="form-control" name="minimum_order_quantity" step="0.01" min="0"
                                   placeholder="100" onchange="updatePreview()">
                            <div class="form-text">Minimum quantity for orders of this grade</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Quality Standard</label>
                            <select class="form-select" name="quality_standard" onchange="updatePreview()">
                                <option value="PREMIUM">Premium</option>
                                <option value="STANDARD" selected>Standard</option>
                                <option value="BASIC">Basic</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grade Components -->
            <div class="custom-card mb-4">
                <div class="card-header-custom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Grade Components</h5>
                        <button type="button" class="btn btn-outline-light btn-sm" onclick="addComponent()">
                            <i class="bi bi-plus-circle"></i> Add Component
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="componentsContainer">
                        <!-- Initial component -->
                        <div class="component-row" data-component="0">
                            <button type="button" class="remove-component" onclick="removeComponent(this)" style="display: none;">
                                <i class="bi bi-x"></i>
                            </button>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Base Grade</label>
                                    <select class="form-select component-grade" name="base_grade_0" required onchange="updateComponent(0)">
                                        <option value="">Select Grade</option>
                                        <optgroup label="Priming Grades (P)">
                                            {% for grade in base_grades %}
                                                {% if grade.category == 'PRIMING' %}
                                                <option value="{{ grade.id }}" 
                                                        data-price="{{ grade.base_price }}" 
                                                        data-category="{{ grade.category }}" 
                                                        data-demand="{{ grade.market_demand }}"
                                                        data-code="{{ grade.grade_code }}">
                                                    {{ grade.grade_code }} - {{ grade.grade_name }} (${{ grade.base_price }}/kg)
                                                </option>
                                                {% endif %}
                                            {% endfor %}
                                        </optgroup>
                                        <optgroup label="Lug Grades (X)">
                                            {% for grade in base_grades %}
                                                {% if grade.category == 'LUG' %}
                                                <option value="{{ grade.id }}" 
                                                        data-price="{{ grade.base_price }}" 
                                                        data-category="{{ grade.category }}" 
                                                        data-demand="{{ grade.market_demand }}"
                                                        data-code="{{ grade.grade_code }}">
                                                    {{ grade.grade_code }} - {{ grade.grade_name }} (${{ grade.base_price }}/kg)
                                                </option>
                                                {% endif %}
                                            {% endfor %}
                                        </optgroup>
                                        <optgroup label="Leaf Grades (L)">
                                            {% for grade in base_grades %}
                                                {% if grade.category == 'LEAF' %}
                                                <option value="{{ grade.id }}" 
                                                        data-price="{{ grade.base_price }}" 
                                                        data-category="{{ grade.category }}" 
                                                        data-demand="{{ grade.market_demand }}"
                                                        data-code="{{ grade.grade_code }}">
                                                    {{ grade.grade_code }} - {{ grade.grade_name }} (${{ grade.base_price }}/kg)
                                                </option>
                                                {% endif %}
                                            {% endfor %}
                                        </optgroup>
                                        <optgroup label="Tip Grades (T)">
                                            {% for grade in base_grades %}
                                                {% if grade.category == 'TIP' %}
                                                <option value="{{ grade.id }}" 
                                                        data-price="{{ grade.base_price }}" 
                                                        data-category="{{ grade.category }}" 
                                                        data-demand="{{ grade.market_demand }}"
                                                        data-code="{{ grade.grade_code }}">
                                                    {{ grade.grade_code }} - {{ grade.grade_name }} (${{ grade.base_price }}/kg)
                                                </option>
                                                {% endif %}
                                            {% endfor %}
                                        </optgroup>
                                        <optgroup label="Strip Grades (A)">
                                            {% for grade in base_grades %}
                                                {% if grade.category == 'STRIP' %}
                                                <option value="{{ grade.id }}" 
                                                        data-price="{{ grade.base_price }}" 
                                                        data-category="{{ grade.category }}" 
                                                        data-demand="{{ grade.market_demand }}"
                                                        data-code="{{ grade.grade_code }}">
                                                    {{ grade.grade_code }} - {{ grade.grade_name }} (${{ grade.base_price }}/kg)
                                                </option>
                                                {% endif %}
                                            {% endfor %}
                                        </optgroup>
                                        <optgroup label="Other Grades">
                                            {% for grade in base_grades %}
                                                {% if grade.category in 'CUTTER,SMOKING,SCRAP' %}
                                                <option value="{{ grade.id }}" 
                                                        data-price="{{ grade.base_price }}" 
                                                        data-category="{{ grade.category }}" 
                                                        data-demand="{{ grade.market_demand }}"
                                                        data-code="{{ grade.grade_code }}">
                                                    {{ grade.grade_code }} - {{ grade.grade_name }} (${{ grade.base_price }}/kg)
                                                </option>
                                                {% endif %}
                                            {% endfor %}
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Percentage (%)</label>
                                    <input type="number" class="form-control component-percentage" name="percentage_0" 
                                           min="0" max="100" step="0.1" required onchange="updateComponent(0)" placeholder="25.0">
                                    <div class="form-text">Component weight in blend</div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Min Quantity (kg)</label>
                                    <input type="number" class="form-control component-min-qty" name="minimum_quantity_0" 
                                           min="0" step="0.01" onchange="updateComponent(0)" placeholder="50">
                                    <div class="form-text">Minimum stock needed</div>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Visual Weight</label>
                                    <div class="component-weight fw-bold text-center p-2 bg-light rounded">0%</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="component-bar">
                                        <div class="component-fill" style="width: 0%;"></div>
                                    </div>
                                    <small class="text-muted component-info">Select a base grade to see details</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info-custom mt-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Tip:</strong> The total percentage of all components should equal 100%. 
                        You can create complex blends by combining different TIMB tobacco categories.
                        Premium grades (P1E, L1E, etc.) will increase your blend's market value.
                    </div>
                </div>
            </div>

            <!-- Special Characteristics -->
            <div class="custom-card mb-4">
                <div class="card-header-custom">
                    <h5 class="mb-0">Special Characteristics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Flavor Profile</label>
                            <select class="form-select" name="flavor_profile" onchange="updatePreview()">
                                <option value="">Select Flavor</option>
                                <option value="MILD">Mild</option>
                                <option value="MEDIUM">Medium</option>
                                <option value="FULL">Full</option>
                                <option value="AROMATIC">Aromatic</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Burn Rate</label>
                            <select class="form-select" name="burn_rate" onchange="updatePreview()">
                                <option value="">Select Burn Rate</option>
                                <option value="SLOW">Slow</option>
                                <option value="MEDIUM">Medium</option>
                                <option value="FAST">Fast</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Moisture Content (%)</label>
                            <input type="number" class="form-control" name="moisture_content" step="0.1" min="0" max="100" onchange="updatePreview()">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nicotine Level</label>
                            <select class="form-select" name="nicotine_level" onchange="updatePreview()">
                                <option value="">Select Level</option>
                                <option value="LOW">Low (< 1.5%)</option>
                                <option value="MEDIUM">Medium (1.5-2.5%)</option>
                                <option value="HIGH">High (> 2.5%)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between mb-4">
                <a href="{% url 'merchant_custom_grades' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Grades
                </a>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="saveDraft()">
                        <i class="bi bi-save"></i> Save Draft
                    </button>
                    <button type="submit" class="btn btn-primary-custom">
                        <i class="bi bi-check-circle"></i> Create Grade
                    </button>
                </div>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="col-lg-4">
            <div class="grade-preview">
                <h6 class="fw-bold mb-3 d-flex align-items-center">
                    <i class="bi bi-eye me-2"></i>
                    Grade Preview
                </h6>
                
                <div class="mb-3">
                    <div class="preview-grade-name h5 text-primary">Custom Grade Name</div>
                    <div class="preview-description text-muted small">Description will appear here...</div>
                </div>
                
                <div class="mb-3 p-3 bg-light rounded">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Target Price:</span>
                        <span class="fw-bold preview-price text-success">$0.00/kg</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Min Order:</span>
                        <span class="preview-min-order">0 kg</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Quality:</span>
                        <span class="preview-quality badge bg-primary">Standard</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6 class="small mb-2 d-flex align-items-center">
                        <i class="bi bi-pie-chart me-2"></i>
                        Composition:
                    </h6>
                    <div id="previewComponents">
                        <div class="text-muted small text-center py-3">
                            <i class="bi bi-plus-circle display-6 d-block mb-2 opacity-50"></i>
                            Add components to see composition
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between small mb-1">
                        <span>Total Percentage:</span>
                        <span id="totalPercentageText">0%</span>
                    </div>
                    <div class="percentage-meter">
                        <div class="percentage-fill" id="totalPercentageFill" style="width: 0%;">
                            0%
                        </div>
                    </div>
                </div>
                
                <div class="mb-3 p-3 border rounded">
                    <h6 class="small mb-2 d-flex align-items-center">
                        <i class="bi bi-calculator me-2"></i>
                        Cost Analysis:
                    </h6>
                    <div class="d-flex justify-content-between small mb-1">
                        <span>Base Cost:</span>
                        <span class="preview-base-cost">$0.00/kg</span>
                    </div>
                    <div class="d-flex justify-content-between small mb-1">
                        <span>Markup:</span>
                        <span class="preview-markup">0%</span>
                    </div>
                    <div class="d-flex justify-content-between small fw-bold border-top pt-1">
                        <span>Profit Margin:</span>
                        <span class="preview-profit text-success">$0.00/kg</span>
                    </div>
                </div>

                <div class="mb-3">
                    <h6 class="small mb-2">Market Demand Indicators:</h6>
                    <div id="demandIndicators" class="small">
                        <div class="text-muted">Add components to see demand analysis</div>
                    </div>
                </div>
                
                <div class="alert alert-warning-custom" id="compositionWarning" style="display: none;">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <small id="warningText">Total percentage should equal 100%</small>
                </div>

                <div class="alert alert-info-custom" id="compositionTips" style="display: none;">
                    <i class="bi bi-lightbulb me-2"></i>
                    <small id="tipsText">Consider adding premium grades for higher market value</small>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
let componentCount = 1;

function addComponent() {
    const container = document.getElementById('componentsContainer');
    const componentHtml = `
        <div class="component-row" data-component="${componentCount}">
            <button type="button" class="remove-component" onclick="removeComponent(this)">
                <i class="bi bi-x"></i>
            </button>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Base Grade</label>
                    <select class="form-select component-grade" name="base_grade_${componentCount}" required onchange="updateComponent(${componentCount})">
                        <option value="">Select Grade</option>
                        <optgroup label="Priming Grades (P)">
                            {% for grade in base_grades %}
                                {% if grade.category == 'PRIMING' %}
                                <option value="{{ grade.id }}" 
                                        data-price="{{ grade.base_price }}" 
                                        data-category="{{ grade.category }}" 
                                        data-demand="{{ grade.market_demand }}"
                                        data-code="{{ grade.grade_code }}">
                                    {{ grade.grade_code }} - {{ grade.grade_name }} (${{ grade.base_price }}/kg)
                                </option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Lug Grades (X)">
                            {% for grade in base_grades %}
                                {% if grade.category == 'LUG' %}
                                <option value="{{ grade.id }}" 
                                        data-price="{{ grade.base_price }}" 
                                        data-category="{{ grade.category }}" 
                                        data-demand="{{ grade.market_demand }}"
                                        data-code="{{ grade.grade_code }}">
                                    {{ grade.grade_code }} - {{ grade.grade_name }} (${{ grade.base_price }}/kg)
                                </option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Leaf Grades (L)">
                            {% for grade in base_grades %}
                                {% if grade.category == 'LEAF' %}
                                <option value="{{ grade.id }}" 
                                        data-price="{{ grade.base_price }}" 
                                        data-category="{{ grade.category }}" 
                                        data-demand="{{ grade.market_demand }}"
                                        data-code="{{ grade.grade_code }}">
                                    {{ grade.grade_code }} - {{ grade.grade_name }} (${{ grade.base_price }}/kg)
                                </option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Tip Grades (T)">
                            {% for grade in base_grades %}
                                {% if grade.category == 'TIP' %}
                                <option value="{{ grade.id }}" 
                                        data-price="{{ grade.base_price }}" 
                                        data-category="{{ grade.category }}" 
                                        data-demand="{{ grade.market_demand }}"
                                        data-code="{{ grade.grade_code }}">
                                    {{ grade.grade_code }} - {{ grade.grade_name }} (${{ grade.base_price }}/kg)
                                </option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Strip Grades (A)">
                            {% for grade in base_grades %}
                                {% if grade.category == 'STRIP' %}
                                <option value="{{ grade.id }}" 
                                        data-price="{{ grade.base_price }}" 
                                        data-category="{{ grade.category }}" 
                                        data-demand="{{ grade.market_demand }}"
                                        data-code="{{ grade.grade_code }}">
                                    {{ grade.grade_code }} - {{ grade.grade_name }} (${{ grade.base_price }}/kg)
                                </option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Other Grades">
                            {% for grade in base_grades %}
                                {% if grade.category in 'CUTTER,SMOKING,SCRAP' %}
                                <option value="{{ grade.id }}" 
                                        data-price="{{ grade.base_price }}" 
                                        data-category="{{ grade.category }}" 
                                        data-demand="{{ grade.market_demand }}"
                                        data-code="{{ grade.grade_code }}">
                                    {{ grade.grade_code }} - {{ grade.grade_name }} (${{ grade.base_price }}/kg)
                                </option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Percentage (%)</label>
                    <input type="number" class="form-control component-percentage" name="percentage_${componentCount}" 
                           min="0" max="100" step="0.1" required onchange="updateComponent(${componentCount})" placeholder="25.0">
                    <div class="form-text">Component weight in blend</div>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Min Quantity (kg)</label>
                    <input type="number" class="form-control component-min-qty" name="minimum_quantity_${componentCount}" 
                           min="0" step="0.01" onchange="updateComponent(${componentCount})" placeholder="50">
                    <div class="form-text">Minimum stock needed</div>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">Visual Weight</label>
                    <div class="component-weight fw-bold text-center p-2 bg-light rounded">0%</div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="component-bar">
                        <div class="component-fill" style="width: 0%;"></div>
                    </div>
                    <small class="text-muted component-info">Select a base grade to see details</small>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', componentHtml);
    componentCount++;
    updateRemoveButtons();
}

function removeComponent(button) {
    button.closest('.component-row').remove();
    updateRemoveButtons();
    updatePreview();
}

function updateRemoveButtons() {
    const components = document.querySelectorAll('.component-row');
    components.forEach((component, index) => {
        const removeBtn = component.querySelector('.remove-component');
        removeBtn.style.display = components.length > 1 ? 'flex' : 'none';
    });
}

function updateComponent(index) {
    const component = document.querySelector(`[data-component="${index}"]`);
    const gradeSelect = component.querySelector('.component-grade');
    const percentageInput = component.querySelector('.component-percentage');
    const weightDiv = component.querySelector('.component-weight');
    const fillDiv = component.querySelector('.component-fill');
    const infoDiv = component.querySelector('.component-info');
    
    const selectedOption = gradeSelect.selectedOptions[0];
    const percentage = parseFloat(percentageInput.value) || 0;
    
    if (selectedOption && selectedOption.value) {
        const gradeName = selectedOption.dataset.code;
        const category = selectedOption.dataset.category;
        const price = selectedOption.dataset.price;
        const demand = selectedOption.dataset.demand;
        
        // Update info display
        const demandClass = demand === 'HIGH' ? 'demand-high' : demand === 'MEDIUM' ? 'demand-medium' : 'demand-low';
        infoDiv.innerHTML = `
            <strong>${gradeName}</strong> (${category}) - $${price}/kg 
            <span class="grade-demand-badge ${demandClass}">${demand} Demand</span>
        `;
        
        component.classList.add('valid');
        component.classList.remove('invalid');
    } else {
        infoDiv.textContent = 'Select a base grade to see details';
        component.classList.remove('valid', 'invalid');
    }
    
    // Update visual weight
    weightDiv.textContent = `${percentage.toFixed(1)}%`;
    fillDiv.style.width = `${Math.min(percentage, 100)}%`;
    
    updatePreview();
}

function updatePreview() {
    const form = document.getElementById('customGradeForm');
    const formData = new FormData(form);
    
    // Update basic info
    const gradeName = formData.get('custom_grade_name') || 'Custom Grade Name';
    const description = formData.get('description') || 'Description will appear here...';
    const targetPrice = parseFloat(formData.get('target_price')) || 0;
    const minOrder = parseFloat(formData.get('minimum_order_quantity')) || 0;
    const quality = formData.get('quality_standard') || 'Standard';
    
    document.querySelector('.preview-grade-name').textContent = gradeName;
    document.querySelector('.preview-description').textContent = description;
    document.querySelector('.preview-price').textContent = `$${targetPrice.toFixed(2)}/kg`;
    document.querySelector('.preview-min-order').textContent = `${minOrder} kg`;
    document.querySelector('.preview-quality').textContent = quality;
    
    // Calculate composition
    let totalPercentage = 0;
    let baseCost = 0;
    let totalDemandScore = 0;
    const components = [];
    const demandCounts = { HIGH: 0, MEDIUM: 0, LOW: 0 };
    
    document.querySelectorAll('.component-row').forEach((component, index) => {
        const gradeSelect = component.querySelector('.component-grade');
        const percentageInput = component.querySelector('.component-percentage');
        
        if (gradeSelect.value && percentageInput.value) {
            const selectedOption = gradeSelect.selectedOptions[0];
            const percentage = parseFloat(percentageInput.value);
            const price = parseFloat(selectedOption.dataset.price);
            const gradeName = selectedOption.dataset.code;
            const demand = selectedOption.dataset.demand;
            
            totalPercentage += percentage;
            baseCost += (price * percentage / 100);
            
            // Calculate demand score
            const demandScore = demand === 'HIGH' ? 3 : demand === 'MEDIUM' ? 2 : 1;
            totalDemandScore += demandScore * (percentage / 100);
            demandCounts[demand]++;
            
            components.push({
                name: gradeName,
                percentage: percentage,
                price: price,
                demand: demand
            });
        }
    });
    
    // Update composition display
    const componentsDiv = document.getElementById('previewComponents');
    if (components.length > 0) {
        componentsDiv.innerHTML = components.map(comp => {
            const demandClass = comp.demand === 'HIGH' ? 'demand-high' : comp.demand === 'MEDIUM' ? 'demand-medium' : 'demand-low';
            return `
                <div class="d-flex justify-content-between align-items-center small mb-1">
                    <span><strong>${comp.name}</strong></span>
                    <div>
                        <span>${comp.percentage.toFixed(1)}%</span>
                        <span class="grade-demand-badge ${demandClass} ms-1">${comp.demand}</span>
                    </div>
                </div>
                <div class="component-bar mb-2">
                    <div class="component-fill" style="width: ${comp.percentage}%;"></div>
                </div>
            `;
        }).join('');
    } else {
        componentsDiv.innerHTML = `
            <div class="text-muted small text-center py-3">
                <i class="bi bi-plus-circle display-6 d-block mb-2 opacity-50"></i>
                Add components to see composition
            </div>
        `;
    }
    
    // Update percentage meter
    const percentageFill = document.getElementById('totalPercentageFill');
    const percentageText = document.getElementById('totalPercentageText');
    
    percentageFill.style.width = `${Math.min(totalPercentage, 100)}%`;
    percentageFill.textContent = `${totalPercentage.toFixed(1)}%`;
    percentageText.textContent = `${totalPercentage.toFixed(1)}%`;
    
    if (totalPercentage < 95 || totalPercentage > 105) {
        percentageFill.style.background = '#dc3545';
    } else {
        percentageFill.style.background = 'linear-gradient(90deg, var(--merchant-secondary, #007bff), var(--merchant-accent, #0056b3))';
    }
    
    // Update cost analysis
    const markup = targetPrice > 0 && baseCost > 0 ? ((targetPrice - baseCost) / baseCost * 100) : 0;
    const profit = targetPrice - baseCost;
    
    document.querySelector('.preview-base-cost').textContent = `$${baseCost.toFixed(2)}/kg`;
    document.querySelector('.preview-markup').textContent = `${markup.toFixed(1)}%`;
    document.querySelector('.preview-profit').textContent = `$${profit.toFixed(2)}/kg`;
    
    // Update demand indicators
    const demandDiv = document.getElementById('demandIndicators');
    if (components.length > 0) {
        const avgDemand = totalDemandScore / components.length;
        const demandLevel = avgDemand > 2.5 ? 'HIGH' : avgDemand > 1.5 ? 'MEDIUM' : 'LOW';
        const demandClass = demandLevel === 'HIGH' ? 'demand-high' : demandLevel === 'MEDIUM' ? 'demand-medium' : 'demand-low';
        
        demandDiv.innerHTML = `
            <div class="d-flex justify-content-between mb-1">
                <span>Overall Demand:</span>
                <span class="grade-demand-badge ${demandClass}">${demandLevel}</span>
            </div>
            <div class="small text-muted">
                High: ${demandCounts.HIGH}, Medium: ${demandCounts.MEDIUM}, Low: ${demandCounts.LOW}
            </div>
        `;
    } else {
        demandDiv.innerHTML = '<div class="text-muted">Add components to see demand analysis</div>';
    }
    
    // Show/hide warnings and tips
    const warning = document.getElementById('compositionWarning');
    const tips = document.getElementById('compositionTips');
    const warningText = document.getElementById('warningText');
    const tipsText = document.getElementById('tipsText');
    
    if (totalPercentage < 95 || totalPercentage > 105) {
        warning.style.display = 'block';
        warningText.textContent = totalPercentage < 95 ? 
            `Need ${(100 - totalPercentage).toFixed(1)}% more components` : 
            `Reduce by ${(totalPercentage - 100).toFixed(1)}%`;
    } else {
        warning.style.display = 'none';
    }
    
    // Show tips based on composition
    let tipMessage = '';
    if (components.length > 0) {
        if (demandCounts.HIGH === 0 && demandCounts.MEDIUM === 0) {
            tipMessage = 'Consider adding high-demand grades to increase market value';
        } else if (profit < 0) {
            tipMessage = 'Increase target price or use lower-cost components';
        } else if (profit > baseCost * 0.5) {
            tipMessage = 'Great profit margin! This blend looks very promising';
        } else if (components.length === 1) {
            tipMessage = 'Consider blending multiple grades for better characteristics';
        }
    }
    
    if (tipMessage) {
        tips.style.display = 'block';
        tipsText.textContent = tipMessage;
    } else {
        tips.style.display = 'none';
    }
}

function saveDraft() {
    const form = document.getElementById('customGradeForm');
    const formData = new FormData(form);
    
    // Collect components data
    const components = [];
    document.querySelectorAll('.component-row').forEach((component, index) => {
        const componentIndex = component.dataset.component;
        const gradeId = formData.get(`base_grade_${componentIndex}`);
        const percentage = formData.get(`percentage_${componentIndex}`);
        const minQty = formData.get(`minimum_quantity_${componentIndex}`);
        
        if (gradeId && percentage) {
            components.push({
                base_grade_id: gradeId,
                percentage: parseFloat(percentage),
                minimum_quantity: parseFloat(minQty) || 0
            });
        }
    });
    
    const data = {
        custom_grade_name: formData.get('custom_grade_name'),
        description: formData.get('description'),
        target_price: parseFloat(formData.get('target_price')) || 0,
        minimum_order_quantity: parseFloat(formData.get('minimum_order_quantity')) || 0,
        quality_standard: formData.get('quality_standard'),
        flavor_profile: formData.get('flavor_profile'),
        burn_rate: formData.get('burn_rate'),
        moisture_content: parseFloat(formData.get('moisture_content')) || null,
        nicotine_level: formData.get('nicotine_level'),
        components: components,
        is_draft: true
    };
    
    fetch('/merchant/api/custom-grades/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Draft saved successfully', 'success');
        } else {
            showNotification('Error saving draft: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error saving draft', 'danger');
    });
}

// Form submission
document.getElementById('customGradeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate total percentage
    let totalPercentage = 0;
    document.querySelectorAll('.component-percentage').forEach(input => {
        if (input.value) {
            totalPercentage += parseFloat(input.value);
        }
    });
    
    if (Math.abs(totalPercentage - 100) > 5) {
        showNotification('Total percentage must be close to 100% (currently ' + totalPercentage.toFixed(1) + '%)', 'warning');
        return;
    }
    
    // Validate at least one component
    const hasComponents = document.querySelectorAll('.component-grade option:checked[value!=""]').length > 0;
    if (!hasComponents) {
        showNotification('Please add at least one component', 'warning');
        return;
    }
    
    const formData = new FormData(this);
    
    // Collect components data
    const components = [];
    document.querySelectorAll('.component-row').forEach((component, index) => {
        const componentIndex = component.dataset.component;
        const gradeId = formData.get(`base_grade_${componentIndex}`);
        const percentage = formData.get(`percentage_${componentIndex}`);
        const minQty = formData.get(`minimum_quantity_${componentIndex}`);
        
        if (gradeId && percentage) {
            components.push({
                base_grade_id: gradeId,
                percentage: parseFloat(percentage),
                minimum_quantity: parseFloat(minQty) || 0
            });
        }
    });
    
    const data = {
        custom_grade_name: formData.get('custom_grade_name'),
        description: formData.get('description'),
        target_price: parseFloat(formData.get('target_price')) || 0,
        minimum_order_quantity: parseFloat(formData.get('minimum_order_quantity')) || 0,
        quality_standard: formData.get('quality_standard'),
        flavor_profile: formData.get('flavor_profile'),
        burn_rate: formData.get('burn_rate'),
        moisture_content: parseFloat(formData.get('moisture_content')) || null,
        nicotine_level: formData.get('nicotine_level'),
        components: components,
        is_draft: false
    };
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Creating...';
    submitBtn.disabled = true;
    
    fetch('/merchant/api/custom-grades/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Custom grade created successfully', 'success');
            setTimeout(() => {
                window.location.href = '/merchant/custom-grades/';
            }, 1500);
        } else {
            showNotification('Error creating grade: ' + (data.error || 'Unknown error'), 'danger');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error creating custom grade', 'danger');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Initialize preview on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for basic info inputs
    const inputs = ['custom_grade_name', 'description', 'target_price', 'minimum_order_quantity'];
    inputs.forEach(name => {
        const element = document.querySelector(`[name="${name}"]`);
        if (element) {
            element.addEventListener('input', updatePreview);
        }
    });
    
    updatePreview();
    updateRemoveButtons();
});
</script>
{% endblock %}