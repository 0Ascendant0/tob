{% extends 'base.html' %}

{% block title %}Farmer Risk Assessment - AI Models{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-6 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Farmer Risk Assessment</h1>
                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
                    AI-powered risk assessment for farmer contract approval
                </p>
            </div>
            <a href="{% url 'ai_models:dashboard' %}" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
    
    <!-- Risk Assessment Form -->
    <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                <i class="fas fa-user-shield mr-2 text-yellow-600"></i>Farmer Risk Assessment
            </h3>
        </div>
        <div class="p-6">
            <form id="risk-assessment-form" class="space-y-8">
                {% csrf_token %}
                
                <!-- Farmer Information Section -->
                <div class="border-b border-gray-200 dark:border-gray-700 pb-6">
                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                        <i class="fas fa-user mr-2 text-blue-600"></i>Farmer Information
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Farmer Name *</label>
                            <input type="text" name="farmer_name" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="John Doe" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Farmer ID *</label>
                            <input type="text" name="farmer_id" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="FARM001" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Location *</label>
                            <select name="location" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required>
                                <option value="">Select Location</option>
                                <option value="Mashonaland">Mashonaland</option>
                                <option value="Matabeleland">Matabeleland</option>
                                <option value="Masvingo">Masvingo</option>
                                <option value="Manicaland">Manicaland</option>
                                <option value="Midlands">Midlands</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Farm Details Section -->
                <div class="border-b border-gray-200 dark:border-gray-700 pb-6">
                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                        <i class="fas fa-seedling mr-2 text-green-600"></i>Farm Details
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Total Hectares *</label>
                            <input type="number" step="0.01" name="total_hectares" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="5.0" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Years of Experience *</label>
                            <input type="number" name="years_experience" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="10" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Primary Tobacco Type *</label>
                            <select name="primary_tobacco_type" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" required>
                                <option value="">Select Type</option>
                                <option value="Flue Cured">Flue Cured</option>
                                <option value="Burley">Burley</option>
                                <option value="Oriental">Oriental</option>
                                <option value="Dark Air Cured">Dark Air Cured</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Financial Information Section -->
                <div class="border-b border-gray-200 dark:border-gray-700 pb-6">
                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                        <i class="fas fa-dollar-sign mr-2 text-green-600"></i>Financial Information
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Annual Income (USD) *</label>
                            <input type="number" step="0.01" name="annual_income" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="15000" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Current Debt Level (USD) *</label>
                            <input type="number" step="0.01" name="debt_level" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="5000" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Previous Defaults *</label>
                            <input type="number" name="previous_defaults" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="0" required>
                        </div>
                    </div>
                </div>
                
                <!-- Proposed Contract Section -->
                <div class="pb-6">
                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                        <i class="fas fa-file-contract mr-2 text-purple-600"></i>Proposed Contract
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Contract Value (USD) *</label>
                            <input type="number" step="0.01" name="proposed_contract_value" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="10000" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Quantity (kg) *</label>
                            <input type="number" step="0.01" name="proposed_quantity" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="2000" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Price per kg (USD) *</label>
                            <input type="number" step="0.01" name="price_per_kg" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="5.00" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Contract Duration (months) *</label>
                            <input type="number" name="contract_duration" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="12" required>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button type="submit" class="bg-yellow-600 text-white px-6 py-2 rounded-lg hover:bg-yellow-700 transition duration-200">
                        <i class="fas fa-user-shield mr-2"></i>Assess Risk
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Results Section -->
    <div id="results-section" class="mt-8 hidden">
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                    <i class="fas fa-chart-line mr-2 text-blue-600"></i>Risk Assessment Results
                </h3>
            </div>
            <div class="p-6">
                <div id="results-content">
                    <!-- Results will be displayed here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('risk-assessment-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    // Show loading state
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Assessing...';
    submitBtn.disabled = true;
    
    try {
        const response = await fetch('{% url "ai_models:assess_farmer_risk_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': data.csrfmiddlewaretoken
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayResults(result.risk_assessment);
        } else {
            alert(`Error: ${result.error}`);
        }
    } catch (error) {
        console.error('Error running risk assessment:', error);
        alert('Error running risk assessment');
    } finally {
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

function displayResults(assessment) {
    const resultsSection = document.getElementById('results-section');
    const resultsContent = document.getElementById('results-content');
    
    const riskLevel = assessment.risk_level;
    const riskColors = {
        'LOW': { text: 'text-green-600', bg: 'bg-green-50 border-green-200', icon: 'check-circle' },
        'MEDIUM': { text: 'text-yellow-600', bg: 'bg-yellow-50 border-yellow-200', icon: 'exclamation-triangle' },
        'HIGH': { text: 'text-orange-600', bg: 'bg-orange-50 border-orange-200', icon: 'exclamation-triangle' },
        'CRITICAL': { text: 'text-red-600', bg: 'bg-red-50 border-red-200', icon: 'times-circle' }
    };
    
    const colors = riskColors[riskLevel] || riskColors['MEDIUM'];
    
    resultsContent.innerHTML = `
        <div class="border rounded-lg p-6 ${colors.bg}">
            <div class="flex items-center justify-between mb-4">
                <h4 class="text-xl font-semibold ${colors.text}">
                    <i class="fas fa-${colors.icon} mr-2"></i>
                    Risk Level: ${riskLevel}
                </h4>
                <div class="text-right">
                    <div class="text-2xl font-bold ${colors.text}">${(assessment.risk_score * 100).toFixed(1)}%</div>
                    <div class="text-sm text-gray-500">Risk Score</div>
                </div>
            </div>
            
            <div class="mb-4">
                <h5 class="font-medium text-gray-900 dark:text-white mb-2">Recommendation:</h5>
                <p class="text-sm text-gray-600 dark:text-gray-400">${assessment.recommendation}</p>
            </div>
            
            ${assessment.risk_factors && assessment.risk_factors.length > 0 ? `
                <div class="mb-4">
                    <h5 class="font-medium text-gray-900 dark:text-white mb-2">Risk Factors:</h5>
                    <ul class="list-disc list-inside space-y-1">
                        ${assessment.risk_factors.map(factor => `<li class="text-sm text-gray-600 dark:text-gray-400">${factor}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
            
            ${assessment.financial_metrics ? `
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mt-4">
                    <div class="text-center p-3 bg-white dark:bg-gray-700 rounded-lg">
                        <div class="text-sm text-gray-500">Debt-to-Income</div>
                        <div class="font-semibold">${(assessment.financial_metrics.debt_to_income_ratio * 100).toFixed(1)}%</div>
                    </div>
                    <div class="text-center p-3 bg-white dark:bg-gray-700 rounded-lg">
                        <div class="text-sm text-gray-500">Contract-to-Income</div>
                        <div class="font-semibold">${(assessment.financial_metrics.contract_to_income_ratio * 100).toFixed(1)}%</div>
                    </div>
                    <div class="text-center p-3 bg-white dark:bg-gray-700 rounded-lg">
                        <div class="text-sm text-gray-500">Yield per Hectare</div>
                        <div class="font-semibold">${assessment.financial_metrics.yield_per_hectare.toFixed(0)}kg</div>
                    </div>
                    <div class="text-center p-3 bg-white dark:bg-gray-700 rounded-lg">
                        <div class="text-sm text-gray-500">Previous Defaults</div>
                        <div class="font-semibold">${assessment.financial_metrics.previous_defaults}</div>
                    </div>
                    <div class="text-center p-3 bg-white dark:bg-gray-700 rounded-lg">
                        <div class="text-sm text-gray-500">Contract Value/ha</div>
                        <div class="font-semibold">$${assessment.financial_metrics.contract_value_per_hectare.toFixed(0)}</div>
                    </div>
                    <div class="text-center p-3 bg-white dark:bg-gray-700 rounded-lg">
                        <div class="text-sm text-gray-500">Income per Hectare</div>
                        <div class="font-semibold">$${assessment.financial_metrics.income_per_hectare.toFixed(0)}</div>
                    </div>
                </div>
            ` : ''}
            
            ${assessment.feature_importance ? `
                <div class="mt-6">
                    <h5 class="font-medium text-gray-900 dark:text-white mb-3">Risk Assessment Breakdown:</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <div class="p-3 bg-white dark:bg-gray-700 rounded-lg">
                            <div class="text-sm text-gray-500">Financial Stability</div>
                            <div class="font-semibold text-red-600">${(assessment.feature_importance.financial_stability * 100).toFixed(1)}%</div>
                        </div>
                        <div class="p-3 bg-white dark:bg-gray-700 rounded-lg">
                            <div class="text-sm text-gray-500">Credit History</div>
                            <div class="font-semibold text-orange-600">${(assessment.feature_importance.credit_history * 100).toFixed(1)}%</div>
                        </div>
                        <div class="p-3 bg-white dark:bg-gray-700 rounded-lg">
                            <div class="text-sm text-gray-500">Experience</div>
                            <div class="font-semibold text-yellow-600">${(assessment.feature_importance.experience * 100).toFixed(1)}%</div>
                        </div>
                        <div class="p-3 bg-white dark:bg-gray-700 rounded-lg">
                            <div class="text-sm text-gray-500">Operational Risk</div>
                            <div class="font-semibold text-blue-600">${(assessment.feature_importance.operational_feasibility * 100).toFixed(1)}%</div>
                        </div>
                        <div class="p-3 bg-white dark:bg-gray-700 rounded-lg">
                            <div class="text-sm text-gray-500">Market/Location</div>
                            <div class="font-semibold text-purple-600">${(assessment.feature_importance.market_location * 100).toFixed(1)}%</div>
                        </div>
                        <div class="p-3 bg-white dark:bg-gray-700 rounded-lg">
                            <div class="text-sm text-gray-500">Contract Terms</div>
                            <div class="font-semibold text-indigo-600">${(assessment.feature_importance.contract_terms * 100).toFixed(1)}%</div>
                        </div>
                    </div>
                </div>
            ` : ''}
        </div>
    `;
    
    resultsSection.classList.remove('hidden');
    resultsSection.scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}
