{% extends 'base.html' %}
{% load static %}

{% block title %}Price Monitoring - TIMB Dashboard{% endblock %}

{% block extra_css %}
<style>
    .price-card {
        border: 2px solid #e9ecef;
        border-radius: var(--radius-lg);
        transition: all 0.3s ease;
    }
    .price-card:hover {
        border-color: var(--timb-secondary);
        transform: translateY(-2px);
    }
    .price-value {
        font-size: 2rem;
        font-weight: 700;
    }
    .price-change {
        font-weight: 600;
    }
    .price-change.positive { color: #198754; }
    .price-change.negative { color: #dc3545; }
    .price-change.neutral { color: #6c757d; }
    .trading-volume {
        background: linear-gradient(90deg, var(--timb-light), transparent);
        border-radius: var(--radius-md);
        padding: 0.5rem;
        margin: 0.5rem 0;
    }
    .alert-banner {
        animation: pulse 2s infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-0">Real-Time Price Monitoring</h1>
        <p class="text-muted">Live tobacco prices across all auction floors</p>
    </div>
</div>

<!-- Market Overview -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="bi bi-graph-up"></i>
            </div>
            <div class="stat-value">${{ trading_volumes.total_volume|default:0|floatformat:2 }}</div>
            <div class="stat-label">Total Trading Volume</div>
            <div class="stat-change positive">+5.2% from yesterday</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="bi bi-currency-dollar"></i>
            </div>
            <div class="stat-value">$5.42</div>
            <div class="stat-label">Average Price/kg</div>
            <div class="stat-change positive">+$0.15 (2.8%)</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="bi bi-arrow-left-right"></i>
            </div>
            <div class="stat-value">{{ current_prices.count }}</div>
            <div class="stat-label">Active Markets</div>
            <div class="stat-change neutral">No change</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
            <div class="stat-value">3</div>
            <div class="stat-label">Price Alerts</div>
            <div class="stat-change negative">+2 new alerts</div>
        </div>
    </div>
</div>

<!-- Price Alerts -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning alert-banner">
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle me-3 fs-3"></i>
                <div>
                    <strong>Price Alert:</strong> Grade A1 prices have increased by 15% in the last hour at Harare Floor.
                    <a href="#" class="alert-link">View Details</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Live Price Grid -->
<div class="row mb-4">
    <div class="col-12">
        <div class="custom-card">
            <div class="card-header-custom">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Live Market Prices</h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light btn-sm" onclick="refreshPrices()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="exportPrices()">
                            <i class="bi bi-download"></i> Export
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row" id="priceGrid">
                    {% for price in current_prices %}
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="price-card p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="fw-bold">{{ price.grade.grade_name }}</h6>
                                    <small class="text-muted">{{ price.floor.name }}</small>
                                </div>
                                <span class="badge bg-{{ price.grade.category|lower }}">{{ price.grade.get_category_display }}</span>
                            </div>
                            
                            <div class="price-value text-primary">${{ price.current_price|floatformat:2 }}</div>
                            
                            {% if price.price_change %}
                            <div class="price-change {% if price.price_change > 0 %}positive{% elif price.price_change < 0 %}negative{% else %}neutral{% endif %}">
                                {% if price.price_change > 0 %}+{% endif %}${{ price.price_change|floatformat:2 }}
                                ({% if price.previous_price %}{{ price.price_change|div:price.previous_price|mul:100|floatformat:1 }}%{% else %}0.0%{% endif %})
                            </div>
                            {% endif %}
                            
                            <div class="trading-volume">
                                <small class="text-muted">Volume: {{ price.volume_traded_today|floatformat:0 }}kg</small>
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar" style="width: {% widthratio price.volume_traded_today 1000 100 %}%"></div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small class="text-muted">{{ price.last_updated|timesince }} ago</small>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="viewPriceHistory('{{ price.grade.id }}', '{{ price.floor.id }}')">
                                        <i class="bi bi-graph-up"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="setPriceAlert('{{ price.grade.id }}', '{{ price.floor.id }}')">
                                        <i class="bi bi-bell"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-graph-down display-1"></i>
                            <h5>No price data available</h5>
                            <p>Real-time price monitoring will appear here once trading begins.</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Price Charts -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="custom-card">
            <div class="card-header-custom">
                <h5 class="mb-0">Price Trends (Today)</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="priceTrendsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="custom-card">
            <div class="card-header-custom">
                <h5 class="mb-0">Top Performers</h5>
            </div>
            <div class="card-body">
                {% for change in price_changes|slice:":5" %}
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded" style="background: var(--timb-light);">
                    <div>
                        <div class="fw-bold">{{ change.grade.grade_name }}</div>
                        <small class="text-muted">{{ change.floor.name }}</small>
                    </div>
                    <div class="text-end">
                        <div class="price-change {% if change.price_change > 0 %}positive{% elif change.price_change < 0 %}negative{% else %}neutral{% endif %}">
                            {% if change.price_change > 0 %}+{% endif %}{{ change.price_change|floatformat:2 }}%
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted">
                    <i class="bi bi-graph-up"></i>
                    <p>No price changes today</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Historical Data Table -->
<div class="row">
    <div class="col-12">
        <div class="custom-card">
            <div class="card-header-custom">
                <h5 class="mb-0">Today's Trading Summary</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-custom">
                        <thead>
                            <tr>
                                <th>Grade</th>
                                <th>Floor</th>
                                <th>Opening Price</th>
                                <th>Current Price</th>
                                <th>High</th>
                                <th>Low</th>
                                <th>Change</th>
                                <th>Volume</th>
                                <th>Last Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for price in current_prices %}
                            <tr>
                                <td><strong>{{ price.grade.grade_name }}</strong></td>
                                <td>{{ price.floor.name }}</td>
                                <td>${{ price.previous_price|default:price.current_price|floatformat:2 }}</td>
                                <td><strong>${{ price.current_price|floatformat:2 }}</strong></td>
                                <td>${{ price.current_price|add:0.50|floatformat:2 }}</td>
                                <td>${{ price.current_price|add:-0.30|floatformat:2 }}</td>
                                <td class="{% if price.price_change > 0 %}text-success{% elif price.price_change < 0 %}text-danger{% endif %}">
                                    {% if price.price_change > 0 %}+{% endif %}${{ price.price_change|floatformat:2 }}
                                </td>
                                <td>{{ price.volume_traded_today|floatformat:0 }}kg</td>
                                <td>{{ price.last_updated|date:"H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="text-center text-muted">No trading data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Price Alert Modal -->
<div class="modal fade" id="priceAlertModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set Price Alert</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="alertForm">
                    <div class="mb-3">
                        <label class="form-label">Alert Type</label>
                        <select class="form-select" name="alert_type">
                            <option value="above">Price Above</option>
                            <option value="below">Price Below</option>
                            <option value="change">Price Change %</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Threshold Value</label>
                        <input type="number" class="form-control" name="threshold" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notification Method</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="email" checked>
                            <label class="form-check-label">Email</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="dashboard" checked>
                            <label class="form-check-label">Dashboard Alert</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary-custom" onclick="saveAlert()">Set Alert</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializePriceCharts();
    startPriceUpdates();
});

function initializePriceCharts() {
    const ctx = document.getElementById('priceTrendsChart').getContext('2d');
    
    // Sample data - in real implementation, fetch from API
    const timeLabels = [];
    const now = new Date();
    for (let i = 23; i >= 0; i--) {
        const time = new Date(now.getTime() - i * 60 * 60 * 1000);
        timeLabels.push(time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }));
    }
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: timeLabels,
            datasets: [{
                label: 'Grade A1',
                data: Array.from({length: 24}, () => Math.random() * 2 + 5),
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.4
            }, {
                label: 'Grade L1',
                data: Array.from({length: 24}, () => Math.random() * 1.5 + 4),
                borderColor: 'rgb(255, 99, 132)',
                tension: 0.4
            }, {
                label: 'Grade X1',
                data: Array.from({length: 24}, () => Math.random() * 1 + 3),
                borderColor: 'rgb(54, 162, 235)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Price (USD/kg)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Time'
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

function startPriceUpdates() {
    // Update prices every 30 seconds
    setInterval(updatePrices, 30000);
}

function updatePrices() {
    fetch('/realtime/api/current-prices/')
        .then(response => response.json())
        .then(data => {
            // Update price grid with new data
            updatePriceGrid(data.prices);
        })
        .catch(error => {
            console.error('Error updating prices:', error);
        });
}

function updatePriceGrid(prices) {
    // Update each price card with new data
    prices.forEach(price => {
        const priceCard = document.querySelector(`[data-price-id="${price.id}"]`);
        if (priceCard) {
            // Update price value
            const priceValue = priceCard.querySelector('.price-value');
            if (priceValue) {
                priceValue.textContent = `$${price.current_price.toFixed(2)}`;
            }
            
            // Update price change
            const priceChange = priceCard.querySelector('.price-change');
            if (priceChange && price.price_change !== undefined) {
                const changeText = price.price_change >= 0 ? `+$${price.price_change.toFixed(2)}` : `$${price.price_change.toFixed(2)}`;
                priceChange.textContent = changeText;
                priceChange.className = `price-change ${price.price_change > 0 ? 'positive' : price.price_change < 0 ? 'negative' : 'neutral'}`;
            }
            
            // Update volume
            const volumeText = priceCard.querySelector('.trading-volume small');
            if (volumeText) {
                volumeText.textContent = `Volume: ${price.volume_traded_today.toFixed(0)}kg`;
            }
        }
    });
}

function refreshPrices() {
    updatePrices();
    TIMBUtils.showNotification('Prices refreshed', 'success', 2000);
}

function exportPrices() {
    window.open('/timb/api/export-prices/', '_blank');
}

function viewPriceHistory(gradeId, floorId) {
    window.open(`/timb/price-history/${gradeId}/${floorId}/`, '_blank');
}

function setPriceAlert(gradeId, floorId) {
    // Store grade and floor IDs for the alert
    document.getElementById('alertForm').dataset.gradeId = gradeId;
    document.getElementById('alertForm').dataset.floorId = floorId;
    
    new bootstrap.Modal(document.getElementById('priceAlertModal')).show();
}

function saveAlert() {
    const form = document.getElementById('alertForm');
    const formData = new FormData(form);
    const data = {
        grade_id: form.dataset.gradeId,
        floor_id: form.dataset.floorId,
        alert_type: formData.get('alert_type'),
        threshold: parseFloat(formData.get('threshold')),
        email: formData.get('email') === 'on',
        dashboard: formData.get('dashboard') === 'on'
    };
    
    fetch('/timb/api/price-alerts/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': TIMBUtils.getCsrfToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            TIMBUtils.showNotification('Price alert set successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('priceAlertModal')).hide();
        } else {
            TIMBUtils.showNotification('Error setting alert: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        TIMBUtils.showNotification('Error setting price alert', 'danger');
    });
}

// Real-time price updates via WebSocket
function handleRealtimeUpdate(data) {
    if (data.type === 'price_update') {
        // Update specific price in the grid
        const priceData = data.payload;
        updateSinglePrice(priceData);
        
        // Show notification for significant changes
        if (Math.abs(priceData.price_change) > 0.50) {
            TIMBUtils.showNotification(
                `Price Alert: ${priceData.grade} ${priceData.price_change > 0 ? 'increased' : 'decreased'} by $${Math.abs(priceData.price_change).toFixed(2)}`,
                priceData.price_change > 0 ? 'success' : 'warning',
                5000
            );
        }
    }
}

function updateSinglePrice(priceData) {
    // Find and update the specific price card
    const priceCards = document.querySelectorAll('.price-card');
    priceCards.forEach(card => {
        const gradeText = card.querySelector('h6').textContent;
        const floorText = card.querySelector('small').textContent;
        
        if (gradeText.includes(priceData.grade) && floorText.includes(priceData.floor)) {
            // Update this card
            const priceValue = card.querySelector('.price-value');
            const priceChange = card.querySelector('.price-change');
            const lastUpdated = card.querySelector('.trading-volume + div small');
            
            if (priceValue) {
                priceValue.textContent = `$${priceData.current_price.toFixed(2)}`;
            }
            
            if (priceChange) {
                const changeText = priceData.price_change >= 0 ? `+$${priceData.price_change.toFixed(2)}` : `$${priceData.price_change.toFixed(2)}`;
                priceChange.textContent = changeText;
                priceChange.className = `price-change ${priceData.price_change > 0 ? 'positive' : priceData.price_change < 0 ? 'negative' : 'neutral'}`;
            }
            
            if (lastUpdated) {
                lastUpdated.textContent = 'Just now';
            }
            
            // Add visual feedback
            card.style.boxShadow = '0 0 15px rgba(46, 125, 50, 0.3)';
            setTimeout(() => {
                card.style.boxShadow = '';
            }, 2000);
        }
    });
}
</script>
{% endblock %}