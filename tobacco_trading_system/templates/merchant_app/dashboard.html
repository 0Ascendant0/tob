{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Merchant Dashboard - {{ merchant.company_name }}{% endblock %}

{% block extra_css %}
<style>
    .widget-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }
    
    .widget {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
    /* Ensure selected cards share consistent, taller height */
    .tall-card {
        min-height: 360px;
        display: flex;
        flex-direction: column;
    }
    .tall-card .card-body { /* helper if used */
        flex: 1 1 auto;
    }
    
    .widget:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }
    
    .metric-trend-up {
        color: #10b981;
    }
    
    .metric-trend-down {
        color: #ef4444;
    }
    
    @media (prefers-color-scheme: dark) {
        .widget {
            background: #1f2937;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    

    <!-- Key Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
        <!-- Weight Tracking Metric -->
        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-lg rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-indigo-100 rounded-md flex items-center justify-center">
                            <i class="fas fa-balance-scale text-indigo-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Avg Weight Completion</dt>
                            <dd class="text-lg font-medium text-gray-900 dark:text-white">
                                {% if merchant and merchant.custom_grades.exists %}
                                        {{ merchant.custom_grades.all|average:"weight_completion_percentage"|floatformat:1 }}%
                                    {% else %}
                                    N/A
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-lg rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-100 rounded-md flex items-center justify-center">
                            <i class="fas fa-boxes text-blue-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Inventory Value</dt>
                            <dd class="text-lg font-medium text-gray-900 dark:text-white">
                                ${{ stats.total_inventory_value|floatformat:2 }}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-lg rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-100 rounded-md flex items-center justify-center">
                            <i class="fas fa-shopping-cart text-green-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Active Orders</dt>
                            <dd class="text-lg font-medium text-gray-900 dark:text-white">{{ stats.active_orders }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-lg rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-100 rounded-md flex items-center justify-center">
                            <i class="fas fa-exchange-alt text-purple-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Today's Trades</dt>
                            <dd class="text-lg font-medium text-gray-900 dark:text-white">{{ stats.todays_transactions }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-lg rounded-lg">
             <div class="p-5">
                 <div class="flex items-center">
                     <div class="flex-shrink-0">
                         <div class="w-8 h-8 bg-yellow-100 rounded-md flex items-center justify-center">
                             <i class="fas fa-weight text-yellow-600"></i>
                         </div>
                     </div>
                     <div class="ml-5 w-0 flex-1">
                         <dl>
                             <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Monthly Volume</dt>
                             <dd class="text-lg font-medium text-gray-900 dark:text-white">{{ stats.monthly_volume|floatformat:0 }}kg</dd>
                         </dl>
                     </div>
                 </div>
             </div>
         </div>
     </div>

     <!-- Weight Tracking Section -->
     <div class="mt-8">
         <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
             <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                 <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                     <i class="fas fa-balance-scale mr-2 text-blue-600"></i>Grade Weight Tracking
                 </h3>
                 <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Monitor acquired weight vs required weight for each grade</p>
             </div>
             <div class="p-6">
                 {% if merchant %}
                     {% for grade in merchant.custom_grades.all %}
                         <div class="mb-4 p-4 border border-gray-200 dark:border-gray-600 rounded-lg">
                             <div class="flex justify-between items-center mb-2">
                                 <h5 class="font-medium text-gray-900 dark:text-white">{{ grade.custom_grade_name }}</h5>
                                 <span class="text-sm px-2 py-1 rounded-full
                                     {% if grade.weight_completion_percentage >= 100 %}bg-green-100 text-green-800
                                     {% elif grade.weight_completion_percentage >= 75 %}bg-yellow-100 text-yellow-800
                                     {% else %}bg-red-100 text-red-800{% endif %}">
                                     {{ grade.weight_completion_percentage|floatformat:1 }}% Complete
                                 </span>
                             </div>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                                 <div class="text-center">
                                     <div class="text-2xl font-bold text-blue-600">{{ grade.required_weight_per_grade|floatformat:0 }}</div>
                                     <div class="text-sm text-gray-600 dark:text-gray-400">Required (kg)</div>
                                 </div>
                                 <div class="text-center">
                                     <div class="text-2xl font-bold text-green-600">{{ grade.acquired_weight_per_grade|floatformat:0 }}</div>
                                     <div class="text-sm text-gray-600 dark:text-gray-400">Acquired (kg)</div>
                                 </div>
                                 <div class="text-center">
                                     <div class="text-2xl font-bold text-orange-600">{{ grade.remaining_weight_needed|floatformat:0 }}</div>
                                     <div class="text-sm text-gray-600 dark:text-gray-400">Remaining (kg)</div>
                                 </div>
                             </div>
                             <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-2">
                                 <div class="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full transition-all duration-300"
                                      style="width: {{ grade.weight_completion_percentage }}%"></div>
                             </div>
                             <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                                 <span>Progress</span>
                                 <span>{{ grade.acquired_weight_per_grade|floatformat:0 }} / {{ grade.required_weight_per_grade|floatformat:0 }} kg</span>
                             </div>
                         </div>
                     {% empty %}
                         <div class="text-center text-gray-500 py-8">
                             <i class="fas fa-balance-scale text-3xl mb-2 opacity-50"></i>
                             <p>No custom grades with weight tracking</p>
                             <a href="{% url 'merchant_create_custom_grade' %}" class="text-blue-600 hover:text-blue-500 text-sm">Create a custom grade →</a>
                         </div>
                     {% endfor %}
                 {% else %}
                     <div class="text-center text-gray-500 py-8">
                         <i class="fas fa-balance-scale text-3xl mb-2 opacity-50"></i>
                         <p>Merchant profile required for weight tracking</p>
                     </div>
                 {% endif %}
             </div>
         </div>
     </div>
    </div>

    <!-- Customizable Widget Area -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="widget-container mb-8">
        <!-- Recent Inventory Widget (light theme only) -->
        <div class="widget bg-white shadow rounded-lg min-h-[260px]">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-warehouse mr-2 text-blue-600"></i>Recent Inventory
                    </h3>
                    <a href="{% url 'merchant_inventory' %}" class="text-sm text-blue-600 hover:text-blue-500">
                        View all →
                    </a>
                </div>
            </div>
            <div class="p-6">
                {% for item in inventory %}
                <div class="flex justify-between items-center py-2 {% if not forloop.last %}border-b border-gray-100{% endif %}">
                    <div>
                        <div class="text-sm font-medium text-gray-900">{{ item.grade.grade_name }}</div>
                        <div class="text-xs text-gray-500">{{ item.storage_location|default:"Main Warehouse" }}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium text-gray-900">{{ item.quantity }}kg</div>
                        <div class="text-xs {% if item.is_low_stock %}text-red-600{% else %}text-gray-500{% endif %}">
                            {% if item.is_low_stock %}
                                <i class="fas fa-exclamation-triangle mr-1"></i>Low Stock
                            {% else %}
                                ${{ item.total_value|floatformat:2 }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-inbox text-3xl mb-2"></i>
                    <p>No inventory items</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Active Orders Widget (light theme only) -->
        <div class="widget bg-white shadow rounded-lg min-h-[260px]">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-list-alt mr-2 text-green-600"></i>Active Orders
                    </h3>
                    <a href="{% url 'merchant_orders' %}" class="text-sm text-green-600 hover:text-green-500">
                        View all →
                    </a>
                </div>
            </div>
            <div class="p-6">
                {% for order in active_orders %}
                <div class="flex justify-between items-center py-2 {% if not forloop.last %}border-b border-gray-100{% endif %}">
                    <div>
                        <div class="text-sm font-medium text-gray-900">{{ order.order_number }}</div>
                        <div class="text-xs text-gray-500">{{ order.client_name }}</div>
                        <div class="text-xs">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                {% if order.status == 'PENDING' %}bg-yellow-100 text-yellow-800
                                {% elif order.status == 'CONFIRMED' %}bg-blue-100 text-blue-800
                                {% elif order.status == 'IN_PROGRESS' %}bg-purple-100 text-purple-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ order.get_status_display }}
                            </span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium text-gray-900">${{ order.total_amount|floatformat:2 }}</div>
                        <div class="text-xs text-gray-500">{{ order.requested_quantity }}kg</div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-clipboard-list text-3xl mb-2"></i>
                    <p>No active orders</p>
                    <a href="{% url 'merchant_create_order' %}" class="text-green-600 hover:text-green-500 text-sm">Create order →</a>
                </div>
                {% endfor %}
            </div>
        </div>


        <!-- Risk Alerts Widget (light theme only) -->
        <div class="widget bg-white shadow rounded-lg tall-card">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-exclamation-triangle mr-2 text-red-600"></i>Risk Alerts
                    </h3>
                    <a href="{% url 'merchant_farmer_risk_assessment' %}" class="text-sm text-red-600 hover:text-red-500">
                        View all →
                    </a>
                </div>
            </div>
            <div class="p-6 card-body">
                {% for risk in risks %}
                <div class="mb-3 p-3 rounded-lg {% if risk.risk_level == 'CRITICAL' %}bg-red-50 border border-red-200{% elif risk.risk_level == 'HIGH' %}bg-yellow-50 border border-yellow-200{% else %}bg-gray-50 border border-gray-200{% endif %}">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-sm font-medium text-gray-900">{{ risk.farmer_name }}</div>
                            <div class="text-xs text-gray-600">{{ risk.ai_recommendation|truncatewords:10 }}</div>
                        </div>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                            {% if risk.risk_level == 'CRITICAL' %}bg-red-100 text-red-800
                            {% elif risk.risk_level == 'HIGH' %}bg-yellow-100 text-yellow-800
                            {% else %}bg-green-100 text-green-800{% endif %}">
                            {{ risk.get_risk_level_display }}
                        </span>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-shield-alt text-3xl mb-2 text-green-500"></i>
                    <p>No risk alerts</p>
                    <p class="text-xs">All assessments are within acceptable limits</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Quick Actions as a card directly under Active Orders (same height as Risk Alerts) -->
        <div class="widget bg-white shadow rounded-lg tall-card">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-bolt mr-2 text-purple-600"></i>Quick Actions
                </h3>
            </div>
            <div class="p-6 card-body">
                <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-4 h-full">
                    <a href="{% url 'merchant_create_order' %}" 
                       class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition duration-200">
                        <i class="fas fa-shopping-cart text-2xl text-green-600 mb-2"></i>
                        <span class="text-sm font-medium text-gray-900">New Order</span>
                    </a>
                    <a href="{% url 'merchant_record_transaction' %}" 
                       class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition duration-200">
                        <i class="fas fa-plus-circle text-2xl text-blue-600 mb-2"></i>
                        <span class="text-sm font-medium text-gray-900">Record Transaction</span>
                    </a>
                    <a href="{% url 'merchant_create_custom_grade' %}" 
                       class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition duration-200">
                        <i class="fas fa-flask text-2xl text-purple-600 mb-2"></i>
                        <span class="text-sm font-medium text-gray-900">Custom Grade</span>
                    </a>
                    <a href="{% url 'merchant_farmer_risk_assessment' %}" 
                       class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition duration-200">
                        <i class="fas fa-user-check text-2xl text-orange-600 mb-2"></i>
                        <span class="text-sm font-medium text-gray-900">Risk Assessment</span>
                    </a>
                    <button onclick="generateQRReport()" 
                            class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition duration-200">
                        <i class="fas fa-qrcode text-2xl text-indigo-600 mb-2"></i>
                        <span class="text-sm font-medium text-gray-900">QR Report</span>
                    </button>
                    <a href="{% url 'merchant_communications' %}" 
                       class="flex flex-col items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition duration-200">
                        <i class="fas fa-comments text-2xl text-pink-600 mb-2"></i>
                        <span class="text-sm font-medium text-gray-900">Messages</span>
                    </a>
                </div>
            </div>
        </div>
        
    </div>

    
    </div>
</div>

<!-- QR Code Modal -->
<div id="qr-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">Inventory QR Report</h3>
                    <button onclick="closeQRModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="qr-content" class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto mb-4"></div>
                    <p class="text-gray-600 dark:text-gray-400">Generating QR code...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Update current time
function updateCurrentTime() {
    const now = new Date();
    document.getElementById('current-time').textContent = now.toLocaleString();
}

// Start real-time updates
let updateInterval;

function startRealTimeUpdates() {
    updateInterval = setInterval(async () => {
        try {
            const response = await fetch('/merchant/api/dashboard-data/');
            const data = await response.json();
            
            if (data) {
                updateDashboardData(data);
            }
        } catch (error) {
            console.error('Error fetching dashboard data:', error);
        }
    }, 30000); // Update every 30 seconds
}

function updateDashboardData(data) {
    // Update metric counters with smooth animation
    animateCounter('inventory-count', data.inventory_count);
    animateCounter('active-orders', data.active_orders);
    animateCounter('todays-transactions', data.todays_transactions);
    
    // Update notification indicators
    updateNotificationCount(data.unread_messages);
}

function animateCounter(elementId, newValue) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const currentValue = parseInt(element.textContent) || 0;
    const increment = (newValue - currentValue) / 20;
    let current = currentValue;
    
    const timer = setInterval(() => {
        current += increment;
        if ((increment > 0 && current >= newValue) || (increment < 0 && current <= newValue)) {
            current = newValue;
            clearInterval(timer);
        }
        element.textContent = Math.round(current);
    }, 50);
}

function updateNotificationCount(count) {
    const badge = document.getElementById('notification-count');
    if (badge) {
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
}

// QR Code generation
async function generateQRReport() {
    document.getElementById('qr-modal').classList.remove('hidden');
    
    try {
        const response = await fetch('/merchant/inventory/qr-report/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('qr-content').innerHTML = `
                <img src="${data.qr_code}" alt="QR Code" class="mx-auto mb-4" style="max-width: 200px;">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Scan to view inventory report</p>
                <p class="text-xs text-gray-500">Expires: ${new Date(data.expires_at).toLocaleString()}</p>
                <div class="mt-4 flex space-x-3">
                    <button onclick="downloadQR('${data.qr_code}')" class="px-4 py-2 bg-primary-600 text-white rounded hover:bg-primary-700">
                        <i class="fas fa-download mr-2"></i>Download
                    </button>
                    <button onclick="shareQR('${data.token}')" class="px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50">
                        <i class="fas fa-share mr-2"></i>Share
                    </button>
                </div>
            `;
        } else {
            document.getElementById('qr-content').innerHTML = `
                <div class="text-red-600 mb-4">
                    <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                    <p>Failed to generate QR code</p>
                    <p class="text-sm">${data.error}</p>
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('qr-content').innerHTML = `
            <div class="text-red-600 mb-4">
                <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                <p>Error generating QR code</p>
            </div>
        `;
    }
}

function closeQRModal() {
    document.getElementById('qr-modal').classList.add('hidden');
}

function downloadQR(qrCodeData) {
    const link = document.createElement('a');
    link.href = qrCodeData;
    link.download = `inventory-report-${new Date().toISOString().split('T')[0]}.png`;
    link.click();
}

function shareQR(token) {
    const url = `${window.location.origin}/auth/qr/verify/${token}/`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Inventory Report',
            text: 'View our inventory report',
            url: url
        });
    } else {
        // Fallback - copy to clipboard
        navigator.clipboard.writeText(url).then(() => {
            window.timbRealTime.showNotification('Link copied to clipboard', 'success');
        });
    }
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
    startRealTimeUpdates();
});

// WebSocket connection for real-time updates
if (window.WebSocket) {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/realtime/dashboard/merchant/`;
    
    const ws = new WebSocket(wsUrl);
    
    ws.onopen = function() {
        window.timbRealTime.updateConnectionStatus(true);
    };
    
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        
        if (data.type === 'dashboard_update') {
            updateDashboardData(data.data);
        } else if (data.type === 'transaction_update') {
            // Show notification for transactions involving this merchant
            window.timbRealTime.showNotification(`New transaction: ${data.data.transaction_id}`, 'info');
        } else if (data.type === 'price_update') {
            // Update price information
            updatePriceAlerts(data.data);
        }
    };
    
    ws.onclose = function() {
        window.timbRealTime.updateConnectionStatus(false);
    };
}

function updatePriceAlerts(priceData) {
    // Show price alerts for grades in inventory
    priceData.forEach(price => {
        if (price.percentage_change > 5) {
            window.timbRealTime.showNotification(
                `${price.grade_code} price increased by ${price.percentage_change.toFixed(1)}%`, 
                'success'
            );
        } else if (price.percentage_change < -5) {
            window.timbRealTime.showNotification(
                `${price.grade_code} price decreased by ${Math.abs(price.percentage_change).toFixed(1)}%`, 
                'warning'
            );
        }
    });
}

// Cleanup
window.addEventListener('beforeunload', function() {
    if (updateInterval) {
        clearInterval(updateInterval);
    }
});
</script>
{% endblock %}