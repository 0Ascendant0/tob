{% extends 'base.html' %}

{% block title %}Inventory Analysis{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto py-4 px-4">
    <div class="mb-4">
        <h1 class="text-2xl font-bold text-gray-900">Inventory Analysis</h1>
        <p class="text-gray-600">View your tobacco inventory and suggested blends</p>
    </div>

    {% if not has_inventory %}
    <div class="bg-yellow-100 border border-yellow-300 rounded p-4">
        <h3 class="font-medium text-yellow-800">No Inventory Found</h3>
        <p class="text-yellow-700">Add some tobacco grades to your inventory first.</p>
        <a href="{% url 'merchant_inventory' %}" class="mt-2 inline-block bg-yellow-600 text-white px-3 py-1 rounded">
            Add Inventory
        </a>
    </div>
    {% else %}
    
    <!-- Simple Summary -->
    <div class="bg-white border rounded mb-4 p-4">
        <h3 class="font-medium mb-3">Summary</h3>
        <div class="grid grid-cols-4 gap-4 text-center">
            <div>
                <div class="text-xl font-bold text-blue-600">{{ total_inventory|floatformat:0 }} kg</div>
                <div class="text-sm text-gray-600">Total</div>
            </div>
            <div>
                <div class="text-xl font-bold text-green-600">{{ inventory_summary|length }}</div>
                <div class="text-sm text-gray-600">Grades</div>
            </div>
            <div>
                <div class="text-xl font-bold text-purple-600">{{ categories|length }}</div>
                <div class="text-sm text-gray-600">Categories</div>
            </div>
            <div>
                <div class="text-xl font-bold text-orange-600">{{ suggestions|length }}</div>
                <div class="text-sm text-gray-600">Blends</div>
            </div>
        </div>

    </div>


    <!-- Inventory Grades -->
    <div class="bg-white border rounded p-4 mb-4">
        <h3 class="font-medium mb-3">Your Inventory Grades</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            {% for grade_code, data in inventory_summary.items %}
            <div class="border rounded p-3">
                <div class="flex justify-between items-start mb-1">
                    <h4 class="font-medium text-sm">{{ grade_code }}</h4>
                    <span class="text-xs text-gray-500">{{ data.category }}</span>
                </div>
                <div class="text-sm text-gray-600 mb-1">{{ data.grade_name }}</div>
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium">{{ data.quantity|floatformat:0 }} kg</span>
                    <span class="text-xs text-gray-500">${{ data.base_price|floatformat:2 }}/kg</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- TIMB Aggregate Grades -->
    <div class="bg-white border rounded p-4 mb-4">
        <h3 class="font-medium mb-3">Possible Aggregate Grades (Based on TIMB Mapping)</h3>
        {% if aggregate_grades %}
        <div class="space-y-3">
            {% for aggregate in aggregate_grades %}
            <div class="border rounded p-3">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h4 class="font-medium text-lg">{{ aggregate.aggregate_code }}</h4>
                        <p class="text-sm text-gray-600">{{ aggregate.available_grades|length }} of {{ aggregate.required_grades|length }} required grades available</p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium">{{ aggregate.coverage_percentage|floatformat:1 }}% Coverage</div>
                        <div class="text-xs text-gray-500">{{ aggregate.total_quantity|floatformat:0 }} kg</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div class="text-center p-2 bg-gray-50 rounded">
                        <div class="font-bold">{{ aggregate.total_quantity|floatformat:0 }} kg</div>
                        <div class="text-xs text-gray-500">Total Quantity</div>
                    </div>
                    <div class="text-center p-2 bg-gray-50 rounded">
                        <div class="font-bold">${{ aggregate.average_price|floatformat:2 }}</div>
                        <div class="text-xs text-gray-500">Avg Price/kg</div>
                    </div>
                </div>

                <div class="mb-3">
                    <h5 class="text-sm font-medium mb-2">Available Grades:</h5>
                    <div class="flex flex-wrap gap-1">
                        {% for grade in aggregate.available_grades %}
                        <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">{{ grade.grade_code }} ({{ grade.quantity|floatformat:0 }}kg)</span>
                        {% endfor %}
                    </div>
                </div>

                {% if aggregate.missing_grades %}
                <div class="mb-3">
                    <h5 class="text-sm font-medium mb-2">Missing Grades:</h5>
                    <div class="flex flex-wrap gap-1">
                        {% for grade in aggregate.missing_grades %}
                        <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">{{ grade }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8">
            <h3 class="font-medium mb-2">No Aggregate Grades Available</h3>
            <p class="text-gray-600">You don't have the required TIMB grades to form any aggregate grades.</p>
        </div>
        {% endif %}
    </div>

    <!-- Simple Suggestions -->
    <div class="bg-white border rounded p-4">
        <h3 class="font-medium mb-3">Suggested Blends</h3>
        {% if suggestions %}
        <div class="space-y-3">
            {% for suggestion in suggestions %}
            <div class="border rounded p-3">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h4 class="font-medium">{{ suggestion.name }}</h4>
                        <p class="text-sm text-gray-600">{{ suggestion.description }}</p>
                    </div>
                    <span class="px-2 py-1 rounded text-xs 
                        {% if suggestion.feasibility == 'HIGH' %}bg-green-100 text-green-800
                        {% elif suggestion.feasibility == 'MEDIUM' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-red-100 text-red-800{% endif %}">
                        {{ suggestion.feasibility }}
                    </span>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div class="text-center p-2 bg-gray-50 rounded">
                        <div class="font-bold">{{ suggestion.total_quantity|floatformat:0 }} kg</div>
                        <div class="text-xs text-gray-500">Total</div>
                    </div>
                    <div class="text-center p-2 bg-gray-50 rounded">
                        <div class="font-bold">${{ suggestion.estimated_price|floatformat:2 }}</div>
                        <div class="text-xs text-gray-500">Price/kg</div>
                    </div>
                </div>

            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8">
            <h3 class="font-medium mb-2">No Suggestions Found</h3>
            <p class="text-gray-600">Add more diverse tobacco grades to enable blending opportunities.</p>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

{% endblock %}
