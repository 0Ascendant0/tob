{% extends 'base.html' %}

{% block title %}TIMB Dashboard{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        transition: transform 0.2s ease-in-out;
    }
    .metric-card:hover {
        transform: translateY(-2px);
    }
    
    .chart-container {
        position: relative;
        height: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">TIMB Dashboard</h1>
                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
                    Real-time tobacco trading oversight • <span id="current-time"></span>
                </p>
            </div>
            <div class="flex space-x-3"></div>
        </div>
    </div>
    
    <!-- Real-time Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="metric-card bg-white dark:bg-gray-800 overflow-hidden shadow-lg rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-100 rounded-md flex items-center justify-center">
                            <i class="fas fa-store text-blue-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Active Merchants</dt>
                            <dd id="active-merchants" class="text-lg font-medium text-gray-900 dark:text-white">{{ stats.total_merchants }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="metric-card bg-white dark:bg-gray-800 overflow-hidden shadow-lg rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-100 rounded-md flex items-center justify-center">
                            <i class="fas fa-exchange-alt text-green-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Today's Transactions</dt>
                            <dd id="todays-transactions" class="text-lg font-medium text-gray-900 dark:text-white">{{ stats.total_transactions_today }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="metric-card bg-white dark:bg-gray-800 overflow-hidden shadow-lg rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-100 rounded-md flex items-center justify-center">
                            <i class="fas fa-weight text-yellow-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Volume Traded (kg)</dt>
                            <dd id="volume-traded" class="text-lg font-medium text-gray-900 dark:text-white">{{ stats.total_volume_today|floatformat:0 }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="metric-card bg-white dark:bg-gray-800 overflow-hidden shadow-lg rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-red-100 rounded-md flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Active Alerts</dt>
                            <dd id="active-alerts" class="text-lg font-medium text-gray-900 dark:text-white">
                                {{ stats.active_alerts }}
                                {% if stats.critical_alerts > 0 %}
                                    <span class="text-red-600">({{ stats.critical_alerts }} critical)</span>
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Recent Transactions -->
        <div class="lg:col-span-2">
            <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg min-h-96 flex flex-col">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                            <i class="fas fa-list mr-2 text-primary-600"></i>Recent Transactions
                        </h3>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-green-500 rounded-full live-indicator"></div>
                            <span class="text-sm text-gray-500">Live</span>
                        </div>
                    </div>
                </div>
                <div class="overflow-hidden flex-1">
                    <div id="transactions-list" class="divide-y divide-gray-200 dark:divide-gray-700 h-full overflow-y-auto">
                        {% for transaction in recent_transactions %}
                        <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition duration-200 {% if transaction.is_flagged %}bg-red-50 dark:bg-red-900{% endif %}">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="flex-shrink-0">
                                        {% if transaction.is_flagged %}
                                            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                                                <i class="fas fa-flag text-red-600"></i>
                                            </div>
                                        {% else %}
                                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                                <i class="fas fa-check text-green-600"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">
                                            {{ transaction.transaction_id }}
                                        </div>
                                        <div class="text-sm text-gray-500">
                                            {% if transaction.seller_id == transaction.buyer_id %}
                                                {{ transaction.buyer.merchant_profile.company_name|default:transaction.buyer.username }} — {{ transaction.get_transaction_type_display|default:transaction.transaction_type }}
                                            {% else %}
                                                {{ transaction.seller.merchant_profile.company_name|default:transaction.seller.username }} → {{ transaction.buyer.merchant_profile.company_name|default:transaction.buyer.username }} — {{ transaction.get_transaction_type_display|default:transaction.transaction_type }}
                                            {% endif %}
                                        </div>
                                        <div class="text-xs text-gray-400">
                                            {{ transaction.grade.grade_name }} • {{ transaction.quantity }}kg @ ${{ transaction.price_per_kg }}/kg
                                            {% if transaction.metadata.barcode_number %}
                                                • Barcode: {{ transaction.metadata.barcode_number }}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                                        ${{ transaction.total_amount|floatformat:2 }}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        {{ transaction.timestamp|timesince }} ago
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="p-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-4 text-gray-300"></i>
                            <p>No transactions today</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="px-6 py-3 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600">
                    <a href="#" class="text-sm text-primary-600 hover:text-primary-500">View all transactions →</a>
                </div>
            </div>
        </div>
        
        <!-- Alerts -->
        <div class="space-y-6">
            <!-- Fraud Alerts (match Recent Transactions height) -->
            <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg min-h-96 flex flex-col">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                        <i class="fas fa-shield-alt mr-2 text-red-600"></i>Fraud Alerts
                    </h3>
                </div>
                <div class="divide-y divide-gray-200 dark:divide-gray-700 flex-1 overflow-y-auto">
                    {% for alert in fraud_alerts %}
                    <div class="p-4">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-red-600 text-sm"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm font-medium text-gray-900 dark:text-white">
                                    {{ alert.title }}
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    {{ alert.created_at|timesince }} ago
                                </div>
                                <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                    {{ alert.description|truncatewords:10 }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="p-4 text-center text-gray-500">
                        <i class="fas fa-check-circle text-green-500 text-2xl mb-2"></i>
                        <p class="text-sm">No active alerts</p>
                    </div>
                    {% endfor %}
                </div>
                {% if fraud_alerts %}
                <div class="px-6 py-3 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600">
                    <a href="#" class="text-sm text-red-600 hover:text-red-500">View all alerts →</a>
                </div>
                {% endif %}
            </div>
            
            <!-- Yield Prediction -->
            
        </div>
    </div>
    
    
    <!-- Trading Volume Chart -->
    <div class="mt-8">
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                    <i class="fas fa-chart-area mr-2 text-primary-600"></i>Trading Volume Trends (Last 7 Days)
                </h3>
            </div>
            <div class="p-6">
                <div class="chart-container">
                    <canvas id="volumeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Real-time update indicator -->
<div id="update-indicator" class="fixed top-20 right-4 bg-green-500 text-white px-3 py-1 rounded-full text-sm hidden">
    <i class="fas fa-sync-alt animate-spin mr-1"></i>
    Updating...
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let volumeChart;
let updateInterval;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeVolumeChart();
    startRealTimeUpdates();
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
    // Check if a new transaction payload was produced by merchant form
    try {
        const payloadRaw = localStorage.getItem('last_transaction_payload');
        if (payloadRaw) {
            const payload = JSON.parse(payloadRaw);
            addNewTransactionToList({
                transaction_id: payload.transaction_id,
                seller: payload.seller,
                buyer: payload.buyer,
                grade: payload.grade,
                quantity: payload.quantity,
                price: payload.price,
                total: payload.total,
                is_flagged: payload.is_flagged
            });
            localStorage.removeItem('last_transaction_payload');
        }
    } catch (e) { /* no-op */ }
});

// Current time display
function updateCurrentTime() {
    const now = new Date();
    document.getElementById('current-time').textContent = now.toLocaleString();
}

// Initialize volume chart
function initializeVolumeChart() {
    const ctx = document.getElementById('volumeChart').getContext('2d');
    const volumeData = {{ volume_trends|safe }};
    
    volumeChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: volumeData.map(item => new Date(item.date).toLocaleDateString()),
            datasets: [{
                label: 'Volume Traded (kg)',
                data: volumeData.map(item => item.volume),
                borderColor: '#5D5CDE',
                backgroundColor: 'rgba(93, 92, 222, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(156, 163, 175, 0.1)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(156, 163, 175, 0.1)'
                    }
                }
            }
        }
    });
}

// Real-time updates
function startRealTimeUpdates() {
    updateInterval = setInterval(async () => {
        try {
            showUpdateIndicator();
            const response = await fetch('/timb/api/realtime-data/');
            const data = await response.json();
            
            if (data) {
                updateDashboardStats(data);
            }
            
            hideUpdateIndicator();
        } catch (error) {
            console.error('Error fetching real-time data:', error);
            hideUpdateIndicator();
        }
    }, 30000); // Update every 30 seconds
}

// Update dashboard statistics
function updateDashboardStats(data) {
    document.getElementById('todays-transactions').textContent = data.transactions_today;
    document.getElementById('volume-traded').textContent = Math.round(data.volume_today).toLocaleString();
    document.getElementById('active-alerts').textContent = data.fraud_alerts;
}

// Show/hide update indicator
function showUpdateIndicator() {
    document.getElementById('update-indicator').classList.remove('hidden');
}

function hideUpdateIndicator() {
    document.getElementById('update-indicator').classList.add('hidden');
}

// Manual refresh
async function refreshDashboard() {
    showUpdateIndicator();
    
    try {
        // Fetch fresh data
        const response = await fetch('/timb/api/realtime-data/');
        const data = await response.json();
        
        if (data) {
            updateDashboardStats(data);
            window.timbRealTime.showNotification('Dashboard refreshed successfully', 'success');
        }
    } catch (error) {
        window.timbRealTime.showNotification('Failed to refresh dashboard', 'error');
    }
    
    hideUpdateIndicator();
}

// Update daily prices
async function updateDailyPrices() {
    try {
        window.timbRealTime.showNotification('Updating daily prices...', 'info');
        
        const response = await fetch('/timb/update-daily-prices/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        });
        
        const data = await response.json();
        
        if (data.success) {
            window.timbRealTime.showNotification(`Updated prices for ${data.updated_count} grades`, 'success');
        } else {
            window.timbRealTime.showNotification('Failed to update prices', 'error');
        }
    } catch (error) {
        window.timbRealTime.showNotification('Error updating prices', 'error');
    }
}

// WebSocket connection for real-time updates
if (window.WebSocket) {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/realtime/dashboard/timb/`;
    
    const ws = new WebSocket(wsUrl);
    
    ws.onopen = function() {
        window.timbRealTime.updateConnectionStatus(true);
    };
    
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        
        if (data.type === 'dashboard_update') {
            updateDashboardStats(data.data);
        } else if (data.type === 'transaction_update') {
            // Add new transaction to the list
            addNewTransactionToList(data.data);
        }
    };
    
    ws.onclose = function() {
        window.timbRealTime.updateConnectionStatus(false);
        // Attempt to reconnect after 5 seconds
        setTimeout(() => {
            location.reload();
        }, 5000);
    };
    
    ws.onerror = function() {
        window.timbRealTime.updateConnectionStatus(false);
    };
}

// Add new transaction to list
function addNewTransactionToList(transaction) {
    const transactionsList = document.getElementById('transactions-list');
    
    const transactionElement = document.createElement('div');
    transactionElement.className = `p-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition duration-200 ${transaction.is_flagged ? 'bg-red-50 dark:bg-red-900' : ''}`;
    
    transactionElement.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="flex-shrink-0">
                    ${transaction.is_flagged ? 
                        '<div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center"><i class="fas fa-flag text-red-600"></i></div>' :
                        '<div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center"><i class="fas fa-check text-green-600"></i></div>'
                    }
                </div>
                <div>
                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                        ${transaction.transaction_id}
                    </div>
                    <div class="text-sm text-gray-500">
                        ${transaction.seller === transaction.buyer ? transaction.buyer : `${transaction.seller} → ${transaction.buyer}`} ${transaction.type ? `— ${transaction.type}` : ''}
                    </div>
                    <div class="text-xs text-gray-400">
                        ${transaction.grade} • ${transaction.quantity}kg @ $${transaction.price}/kg
                        ${transaction.barcode_number ? ` • Barcode: ${transaction.barcode_number}` : ''}
                    </div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-sm font-medium text-gray-900 dark:text-white">
                    $${transaction.total.toFixed(2)}
                </div>
                <div class="text-xs text-gray-500">
                    Just now
                </div>
            </div>
        </div>
    `;
    
    // Add to top of list
    transactionsList.insertBefore(transactionElement, transactionsList.firstChild);
    
    // Remove last item if list is too long
    if (transactionsList.children.length > 10) {
        transactionsList.removeChild(transactionsList.lastChild);
    }
    
    // Show notification for flagged transactions
    if (transaction.is_flagged) {
        window.timbRealTime.showNotification(`Flagged transaction detected: ${transaction.transaction_id}`, 'warning');
    }
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (updateInterval) {
        clearInterval(updateInterval);
    }
});
</script>
{% endblock %}