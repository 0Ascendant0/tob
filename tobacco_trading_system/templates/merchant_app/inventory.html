{% extends 'base.html' %}
{% load static %}

{% block title %}Inventory - Merchant Dashboard{% endblock %}

{% block extra_css %}
<style>
    .inventory-item {
        border: 2px solid #e9ecef;
        border-radius: var(--radius-lg);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .inventory-item:hover {
        border-color: var(--merchant-secondary);
        transform: translateY(-2px);
    }
    .low-stock {
        border-color: #ffc107;
        background: #fff8e1;
    }
    .out-of-stock {
        border-color: #dc3545;
        background: #fef2f2;
    }
    .grade-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
    }
    .stock-indicator {
        width: 100%;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
    }
    .stock-fill {
        height: 100%;
        transition: width 0.5s ease;
    }
    .qr-code-container {
        position: relative;
        background: white;
        padding: 1rem;
        border-radius: var(--radius-md);
        border: 2px dashed #ccc;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h3 mb-0">Inventory Management</h1>
        <p class="text-muted">Manage your tobacco inventory with real-time tracking</p>
    </div>
</div>

<!-- Inventory Summary -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="merchant-card">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <div class="metric-value">${{ total_value|floatformat:2 }}</div>
                    <div>Total Value</div>
                </div>
                <div class="metric-icon">
                    <i class="bi bi-currency-dollar fs-1"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="merchant-card">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <div class="metric-value">{{ total_quantity|floatformat:0 }}</div>
                    <div>Total Quantity (kg)</div>
                </div>
                <div class="metric-icon">
                    <i class="bi bi-box-seam fs-1"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="merchant-card">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <div class="metric-value">{{ inventory.count }}</div>
                    <div>Unique Grades</div>
                </div>
                <div class="metric-icon">
                    <i class="bi bi-grid fs-1"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="merchant-card">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <div class="metric-value text-warning">{{ low_stock_items.count }}</div>
                    <div>Low Stock Alerts</div>
                </div>
                <div class="metric-icon">
                    <i class="bi bi-exclamation-triangle fs-1"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Low Stock Alerts -->
{% if low_stock_items %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning-custom">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Low Stock Alert:</strong> {{ low_stock_items.count }} items are running low.
            <a href="#low-stock-section" class="alert-link">View low stock items</a>
        </div>
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="custom-card">
            <div class="card-header-custom">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <button class="btn btn-primary-custom w-100 mb-2" onclick="addInventoryItem()">
                            <i class="bi bi-plus-circle me-2"></i>Add New Item
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-success w-100 mb-2" onclick="generateInventoryReport()">
                            <i class="bi bi-file-earmark-text me-2"></i>Generate Report
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-info w-100 mb-2" onclick="bulkUpdate()">
                            <i class="bi bi-arrow-repeat me-2"></i>Bulk Update
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-warning w-100 mb-2" onclick="exportInventory()">
                            <i class="bi bi-download me-2"></i>Export CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Inventory Grid -->
<div class="row mb-4">
    <div class="col-12">
        <div class="custom-card">
            <div class="card-header-custom">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Current Inventory</h5>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" onchange="filterInventory(this.value)">
                            <option value="">All Grades</option>
                            <option value="STRIP">Strip Grades</option>
                            <option value="LEAF">Leaf Grades</option>
                            <option value="LUG">Lug Grades</option>
                            <option value="TIP">Tip Grades</option>
                        </select>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary active" onclick="setView('grid')">
                                <i class="bi bi-grid"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="setView('list')">
                                <i class="bi bi-list"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row" id="inventoryGrid">
                    {% for item in inventory %}
                    <div class="col-lg-4 col-md-6 mb-3 inventory-grid-item" data-category="{{ item.grade.category }}">
                        <div class="inventory-item p-3 position-relative {% if item.quantity < 100 %}low-stock{% elif item.quantity == 0 %}out-of-stock{% endif %}" onclick="viewInventoryItem({{ item.id }})">
                            <span class="badge bg-{{ item.grade.category|lower }} grade-badge">{{ item.grade.get_category_display }}</span>
                            
                            <h6 class="fw-bold mb-2">{{ item.grade.grade_name }}</h6>
                            <p class="text-muted small mb-2">{{ item.location }}</p>
                            
                            <div class="row mb-3">
                                <div class="col-6">
                                    <div class="fw-bold text-primary">${{ item.average_cost|floatformat:2 }}</div>
                                    <small class="text-muted">Avg Cost/kg</small>
                                </div>
                                <div class="col-6 text-end">
                                    <div class="fw-bold">{{ item.quantity|floatformat:0 }}kg</div>
                                    <small class="text-muted">Available</small>
                                </div>
                            </div>
                            
                            <div class="mb-2">
                                <div class="d-flex justify-content-between mb-1">
                                    <small>Stock Level</small>
                                    <small>{{ item.quantity|floatformat:0 }}/1000kg</small>
                                </div>
                                <div class="stock-indicator">
                                    <div class="stock-fill bg-{% if item.quantity < 100 %}warning{% elif item.quantity < 50 %}danger{% else %}success{% endif %}" 
                                         style="width: {% widthratio item.quantity 1000 100 %}%"></div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">Updated: {{ item.last_updated|timesince }} ago</small>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="event.stopPropagation(); editItem({{ item.id }})">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-success" onclick="event.stopPropagation(); generateQR({{ item.id }})">
                                        <i class="bi bi-qr-code"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-2">
                                <div class="fw-bold text-success">Total Value: ${{ item.quantity|mul:item.average_cost|floatformat:2 }}</div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-box display-1"></i>
                            <h5>No inventory items</h5>
                            <p>Start by adding your first inventory item.</p>
                            <button class="btn btn-primary-custom" onclick="addInventoryItem()">
                                <i class="bi bi-plus-circle me-2"></i>Add First Item
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Low Stock Items -->
{% if low_stock_items %}
<div class="row" id="low-stock-section">
    <div class="col-12">
        <div class="custom-card">
            <div class="card-header-custom bg-warning">
                <h5 class="mb-0 text-dark">Low Stock Items</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-custom">
                        <thead>
                            <tr>
                                <th>Grade</th>
                                <th>Location</th>
                                <th>Current Stock</th>
                                <th>Avg Cost</th>
                                <th>Total Value</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in low_stock_items %}
                            <tr>
                                <td><strong>{{ item.grade.grade_name }}</strong></td>
                                <td>{{ item.location }}</td>
                                <td>
                                    <span class="text-warning fw-bold">{{ item.quantity|floatformat:0 }}kg</span>
                                    <div class="progress mt-1" style="height: 4px;">
                                        <div class="progress-bar bg-warning" style="width: {% widthratio item.quantity 100 100 %}%"></div>
                                    </div>
                                </td>
                                <td>${{ item.average_cost|floatformat:2 }}</td>
                                <td>${{ item.quantity|mul:item.average_cost|floatformat:2 }}</td>
                                <td>{{ item.last_updated|timesince }} ago</td>
                                <td>
                                    <button class="btn btn-warning btn-sm" onclick="reorderItem({{ item.id }})">
                                        <i class="bi bi-arrow-repeat"></i> Reorder
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Add/Edit Inventory Modal -->
<div class="modal fade" id="inventoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Inventory Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="inventoryForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Grade</label>
                            <select class="form-select" name="grade" required>
                                <option value="">Select Grade</option>
                                <!-- This would be populated from the backend -->
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" name="location" placeholder="Storage location" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Quantity (kg)</label>
                            <input type="number" class="form-control" name="quantity" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Average Cost ($/kg)</label>
                            <input type="number" class="form-control" name="average_cost" step="0.01" min="0" required>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Storage Conditions</label>
                            <textarea class="form-control" name="storage_conditions" rows="3" placeholder="Temperature, humidity, special requirements..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary-custom" onclick="saveInventoryItem()">Save Item</button>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Inventory Item QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="qr-code-container">
                    <div id="qrCodeDisplay">
                        <!-- QR code will be inserted here -->
                    </div>
                    <p class="mt-3 mb-0">Scan to access encrypted inventory data</p>
                </div>
                <div class="mt-3">
                    <div class="alert alert-info-custom">
                        <i class="bi bi-info-circle me-2"></i>
                        This QR code contains encrypted access to inventory details and expires in 2 hours.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary-custom" onclick="downloadQR()">Download QR</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentView = 'grid';

function setView(view) {
    currentView = view;
    const buttons = document.querySelectorAll('.btn-group button');
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    if (view === 'list') {
        // Convert to list view
        document.getElementById('inventoryGrid').className = 'col-12';
        // Implementation would change the display structure
    } else {
        // Grid view
        document.getElementById('inventoryGrid').className = 'row';
    }
}

function filterInventory(category) {
    const items = document.querySelectorAll('.inventory-grid-item');
    items.forEach(item => {
        if (category === '' || item.dataset.category === category) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function viewInventoryItem(itemId) {
    // Navigate to detailed view or show modal with full details
    fetch(`/merchant/api/inventory/${itemId}/`)
        .then(response => response.json())
        .then(data => {
            // Show detailed modal or navigate to detail page
            console.log('Item details:', data);
        })
        .catch(error => {
            console.error('Error:', error);
            TIMBUtils.showNotification('Error loading item details', 'danger');
        });
}

function addInventoryItem() {
    document.getElementById('inventoryForm').reset();
    document.querySelector('#inventoryModal .modal-title').textContent = 'Add Inventory Item';
    new bootstrap.Modal(document.getElementById('inventoryModal')).show();
}

function editItem(itemId) {
    // Load item data and populate form
    fetch(`/merchant/api/inventory/${itemId}/`)
        .then(response => response.json())
        .then(data => {
            // Populate form with existing data
            const form = document.getElementById('inventoryForm');
            Object.keys(data).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    input.value = data[key];
                }
            });
            
            document.querySelector('#inventoryModal .modal-title').textContent = 'Edit Inventory Item';
            form.dataset.itemId = itemId;
            new bootstrap.Modal(document.getElementById('inventoryModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            TIMBUtils.showNotification('Error loading item data', 'danger');
        });
}

function saveInventoryItem() {
    const form = document.getElementById('inventoryForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    const url = form.dataset.itemId ? 
        `/merchant/api/inventory/${form.dataset.itemId}/` : 
        '/merchant/api/inventory/';
    
    const method = form.dataset.itemId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'X-CSRFToken': TIMBUtils.getCsrfToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            TIMBUtils.showNotification('Inventory item saved successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('inventoryModal')).hide();
            location.reload();
        } else {
            TIMBUtils.showNotification('Error saving item: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        TIMBUtils.showNotification('Error saving inventory item', 'danger');
    });
}

function generateQR(itemId) {
    fetch(`/merchant/api/inventory/${itemId}/qr/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': TIMBUtils.getCsrfToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.qr_code) {
            document.getElementById('qrCodeDisplay').innerHTML = 
                `<img src="data:image/png;base64,${data.qr_code}" alt="QR Code" class="img-fluid">`;
            
            new bootstrap.Modal(document.getElementById('qrModal')).show();
        } else {
            TIMBUtils.showNotification('Error generating QR code', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        TIMBUtils.showNotification('Error generating QR code', 'danger');
    });
}

function downloadQR() {
    const img = document.querySelector('#qrCodeDisplay img');
    if (img) {
        const link = document.createElement('a');
        link.download = 'inventory-qr-code.png';
        link.href = img.src;
        link.click();
    }
}

function reorderItem(itemId) {
    TIMBUtils.showConfirmDialog(
        'Generate reorder recommendation for this item?',
        () => {
            fetch(`/merchant/api/inventory/${itemId}/reorder/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': TIMBUtils.getCsrfToken(),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    TIMBUtils.showNotification('Reorder recommendation generated', 'success');
                    // Redirect to purchase recommendations page
                    window.location.href = '/merchant/recommendations/';
                } else {
                    TIMBUtils.showNotification('Error generating recommendation: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                TIMBUtils.showNotification('Error generating reorder recommendation', 'danger');
            });
        }
    );
}

function generateInventoryReport() {
    TIMBUtils.showLoader();
    
    fetch('/merchant/api/inventory/report/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': TIMBUtils.getCsrfToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.blob())
    .then(blob => {
        TIMBUtils.hideLoader();
        
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `inventory-report-${new Date().toISOString().split('T')[0]}.pdf`;
        link.click();
        window.URL.revokeObjectURL(url);
        
        TIMBUtils.showNotification('Inventory report generated', 'success');
    })
    .catch(error => {
        TIMBUtils.hideLoader();
        console.error('Error:', error);
        TIMBUtils.showNotification('Error generating report', 'danger');
    });
}

function bulkUpdate() {
    // Implementation for bulk update functionality
    TIMBUtils.showNotification('Bulk update feature coming soon', 'info');
}

function exportInventory() {
    window.open('/merchant/api/inventory/export/', '_blank');
}
</script>
{% endblock %}