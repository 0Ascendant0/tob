{% extends 'base.html' %}
{% load static %}

{% block title %}Change Password - {{ merchant.company_name }}{% endblock %}

{% block extra_css %}
<style>
    .password-strength {
        height: 4px;
        border-radius: 2px;
        transition: all 0.3s ease;
    }

    .password-strength.weak {
        background: linear-gradient(to right, #dc3545 33%, #f8f9fa 33%);
    }

    .password-strength.medium {
        background: linear-gradient(to right, #ffc107 66%, #f8f9fa 66%);
    }

    .password-strength.strong {
        background: linear-gradient(to right, #28a745 100%, #f8f9fa 100%);
    }

    .password-requirements {
        font-size: 0.875rem;
        color: #6c757d;
    }

    .password-requirements .valid {
        color: #28a745;
    }

    .password-requirements .invalid {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'merchant_dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'merchant_profile_customization' %}">Profile</a></li>
                <li class="breadcrumb-item active">Change Password</li>
            </ol>
        </nav>
        <h1 class="h3 mb-0">Change Password</h1>
        <p class="text-muted">Update your account password for security</p>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header bg-primary-custom text-white">
                <h5 class="mb-0"><i class="bi bi-shield-lock me-2"></i>Change Password</h5>
            </div>
            <div class="card-body">
                <form method="post" id="changePasswordForm">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="current_password" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="current_password" name="current_password"
                               required placeholder="Enter your current password">
                        <div class="form-text">Enter your current password to verify your identity.</div>
                    </div>

                    <div class="mb-3">
                        <label for="new_password" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="new_password" name="new_password"
                               required placeholder="Enter your new password">
                        <div class="password-strength mt-2" id="passwordStrength"></div>
                        <div class="password-requirements mt-2">
                            <div id="lengthReq" class="requirement">
                                <i class="bi bi-x-circle-fill invalid me-1"></i>
                                At least 8 characters long
                            </div>
                            <div id="uppercaseReq" class="requirement">
                                <i class="bi bi-x-circle-fill invalid me-1"></i>
                                Contains uppercase letter
                            </div>
                            <div id="lowercaseReq" class="requirement">
                                <i class="bi bi-x-circle-fill invalid me-1"></i>
                                Contains lowercase letter
                            </div>
                            <div id="numberReq" class="requirement">
                                <i class="bi bi-x-circle-fill invalid me-1"></i>
                                Contains number
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="confirm_password" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirm_password" name="confirm_password"
                               required placeholder="Confirm your new password">
                        <div class="form-text" id="confirmText">Re-enter your new password to confirm.</div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary-custom" id="submitBtn">
                            <i class="bi bi-save me-2"></i>Change Password
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mt-4 border-warning">
            <div class="card-body">
                <h6 class="card-title text-warning">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Security Notice
                </h6>
                <ul class="mb-0 small">
                    <li>Choose a strong password that you haven't used elsewhere</li>
                    <li>Avoid common words, names, or sequential characters</li>
                    <li>Consider using a password manager for secure storage</li>
                    <li>You will be logged out and need to log in with your new password</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_password');
    const passwordStrength = document.getElementById('passwordStrength');
    const submitBtn = document.getElementById('submitBtn');
    const confirmText = document.getElementById('confirmText');

    // Password requirements elements
    const lengthReq = document.getElementById('lengthReq');
    const uppercaseReq = document.getElementById('uppercaseReq');
    const lowercaseReq = document.getElementById('lowercaseReq');
    const numberReq = document.getElementById('numberReq');

    function checkPasswordStrength(password) {
        let score = 0;
        const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /\d/.test(password)
        };

        // Update requirement indicators
        lengthReq.className = requirements.length ? 'valid' : 'invalid';
        lengthReq.querySelector('i').className = requirements.length ?
            'bi bi-check-circle-fill valid me-1' : 'bi bi-x-circle-fill invalid me-1';

        uppercaseReq.className = requirements.uppercase ? 'valid' : 'invalid';
        uppercaseReq.querySelector('i').className = requirements.uppercase ?
            'bi bi-check-circle-fill valid me-1' : 'bi bi-x-circle-fill invalid me-1';

        lowercaseReq.className = requirements.lowercase ? 'valid' : 'invalid';
        lowercaseReq.querySelector('i').className = requirements.lowercase ?
            'bi bi-check-circle-fill valid me-1' : 'bi bi-x-circle-fill invalid me-1';

        numberReq.className = requirements.number ? 'valid' : 'invalid';
        numberReq.querySelector('i').className = requirements.number ?
            'bi bi-check-circle-fill valid me-1' : 'bi bi-x-circle-fill invalid me-1';

        // Calculate strength
        if (requirements.length) score++;
        if (requirements.uppercase) score++;
        if (requirements.lowercase) score++;
        if (requirements.number) score++;

        // Update strength indicator
        passwordStrength.className = 'password-strength';
        if (score <= 2) {
            passwordStrength.classList.add('weak');
        } else if (score <= 3) {
            passwordStrength.classList.add('medium');
        } else {
            passwordStrength.classList.add('strong');
        }

        return score === 4;
    }

    function checkPasswordMatch() {
        const password = newPassword.value;
        const confirm = confirmPassword.value;

        if (confirm === '') {
            confirmText.textContent = 'Re-enter your new password to confirm.';
            confirmText.className = 'form-text';
            return false;
        }

        if (password === confirm) {
            confirmText.textContent = 'Passwords match.';
            confirmText.className = 'form-text text-success';
            return true;
        } else {
            confirmText.textContent = 'Passwords do not match.';
            confirmText.className = 'form-text text-danger';
            return false;
        }
    }

    function validateForm() {
        const password = newPassword.value;
        const confirm = confirmPassword.value;
        const current = document.getElementById('current_password').value;

        const isStrong = checkPasswordStrength(password);
        const matches = checkPasswordMatch();
        const hasCurrent = current.length > 0;

        submitBtn.disabled = !(isStrong && matches && hasCurrent);
    }

    // Event listeners
    newPassword.addEventListener('input', function() {
        checkPasswordStrength(this.value);
        checkPasswordMatch();
        validateForm();
    });

    confirmPassword.addEventListener('input', function() {
        checkPasswordMatch();
        validateForm();
    });

    document.getElementById('current_password').addEventListener('input', validateForm);

    // Form submission
    document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
        if (!checkPasswordStrength(newPassword.value)) {
            e.preventDefault();
            alert('Please ensure your new password meets all requirements.');
            return false;
        }

        if (newPassword.value !== confirmPassword.value) {
            e.preventDefault();
            alert('Passwords do not match.');
            return false;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Changing Password...';
    });
});
</script>
{% endblock %}